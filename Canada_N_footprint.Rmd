---
title: "Canadian N Footprint"
output: html_notebook
---

```{r libraries, echo=FALSE, message = FALSE}
library(markdown)
library(readr)
library(dplyr)
library(tidyr)
library(readxl)
library(ggplot2)
library(wesanderson)
```

# SCOPE & DATA

## Temporal
```{r temporal_scope , echo=FALSE, message = FALSE}
years = c(2016, 2017, 2018)
```

## Population 
```{r population_data, echo=FALSE, message = FALSE}
#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/17100009-eng.zip")
pop_raw <- read_csv("Data/Population/17100009.csv")

prov_pop <- as_tibble(pop_raw)%>%
  separate(REF_DATE, sep="-", into=c("REF_DATE", "month"))%>%
  filter(month == "01")%>%
  select(REF_DATE, GEO, VALUE)

prov_pop$REF_DATE <- as.integer(prov_pop$REF_DATE)

prov_pop <- prov_pop%>%
  filter(REF_DATE %in% years)%>%
  group_by(GEO)%>%
  summarize(Population = mean(VALUE))
```

```{r crop_categories , echo=FALSE, message = FALSE}
animal_list = c("Beef", "Pork", "Chicken", "Milk", "Eggs")

field_crop_list = c("Barley", "Beans, all dry (white and coloured)", "Buckwheat", "Canary seed", "Canola (rapeseed)", "Chick peas", "Corn for grain", "Corn for silage", "Faba beans", "Flaxseed", "Lentils", "Rye, all", "Oats", "Soybeans", "Sugar beets", "Peas, dry", "Sunflower seed", "Tame hay", "Triticale", "Wheat, all")                                          
#removed subcategories/duplicates "Beans, dry white", "Beans, dry coloured", "Rye, all including fall rye remaining" "Rye, fall remaining" "Rye, spring" "Rye, fall seeded in previous fall" "Wheat, all including winter wheat remaining" "Wheat, durum" "Wheat, spring" "Wheat, Canada Western Extra Strong (CWES)" "Wheat, Canada Western Red Spring (CWRS)"  "Wheat, Canada Prairie Spring Red (CPSR) and Canada Prairie Spring White (CPSW)" "Wheat, Canada Western Soft White Spring (CWSWS)" "Wheat, other spring" "Wheat, winter remaining" "Wheat, winter seeded in fall" "Wheat, all excluding durum wheat""Wheat, Canada Western Special Purpose (CWSP)" "Wheat, Canada Western Hard White Spring (CWHWS)" "Wheat, Canada Northern Hard Red (CNHR)" "Wheat, Canada Eastern Red Spring (CERS)"
#removed "Borage seed" "Caraway seed" "Coriander seed" "Mustard seed" "Safflower" "Hemp" (no recommended fert rates or no longer reported)                     
fruit_list = c("apples", "blueberries", "grapes", "peaches", "pears", "plums and prune plums", "raspberries", "strawberries", "nectarines", "apricots", "sour cherries", "sweet cherries", "cranberries", "saskatoon berries", "blackberries", "currants", "haskaps")
# removed subcategories/duplicates  "highbush blueberries" "lowbush blueberries" "Labrusca grapes" "vinifera, fresh French hybrid grapes "                
vegetable_list = c("cabbage", "rutabagas and turnips", "beets", "cauliflowers", "sweet corn", "lettuce", "parsnips", "green and wax beans", "carrots", "cucumbers and fresh gherkins (all varieties)", "tomatoes", "green peas", "asparagus", "celery", "dry onions", "spinach", "peppers", "radishes ", "garlic", "rhubarb", "broccoli", "Brussels sprouts", "leeks", "pumpkins", "French shallots and green onions", "squash and zucchini", "Asian radishes", "kale", "eggplants (except Chinese eggplants)", "radishes (except Asian radishes)", "sweet potatoes")
#removed parsely, regular cabbage" "Chinese cabbage" watermelons

grain_list = c("Barley", "Corn for grain", "Oats", "Wheat, all")

legume_list = c("Beans, all dry (white and coloured)", "Chick peas", "Faba beans", "Lentils", "Soybeans", "Peas, dry")

oilseed_list = c("Canola (rapeseed)")

root_list = c("Potaoes", "carrots", "dry onions", "parsnips", "sweet potatoes")

crop_list = c("Barley", "Beans, all dry (white and coloured)", "Buckwheat", "Canary seed", "Canola (rapeseed)", "Chick peas", "Corn for grain", "Corn for silage", "Faba beans", "Flaxseed", "Lentils", "Rye, all", "Oats", "Soybeans", "Sugar beets", "Oats", "Peas, dry", "Sunflower seed", "Tame hay", "Triticale", "Wheat, all", "apples", "blueberries", "grapes", "peaches", "pears", "plums and prune plums", "raspberries", "strawberries", "nectarines", "apricots", "sour cherries", "sweet cherries", "cranberries", "saskatoon berries", "blackberries", "currants", "haskaps", "cabbage", "rutabagas and turnips", "beets", "cauliflowers", "sweet corn", "lettuce", "parsnips", "green and wax beans", "carrots", "cucumbers and fresh gherkins (all varieties)", "tomatoes", "green peas", "asparagus", "celery", "dry onions", "spinach", "peppers", "radishes ", "garlic", "rhubarb", "broccoli", "Brussels sprouts", "leeks", "pumpkins", "French shallots and green onions", "squash and zucchini", "Asian radishes", "kale", "eggplants (except Chinese eggplants)", "radishes (except Asian radishes)", "sweet potatoes")

#food_crop_list = c("Spring wheat", "Winter wheat", "Corn for grain", "Canola", "Soybeans", "Potatoes", "Apples", "Grapes", "Blueberries", "Strawberries", #"Peaches", "Cranberries", "Tomatoes", "Carrots", "Onions", "Cabbage", "Pumpkins")

#feed_crop_list = c("Spring wheat", "Winter wheat", "Corn for silage", "Oats", "Soybeans", "Tame hay", "Barley")
```

## Download and clean crop files
```{r crop_data, echo=FALSE, message = FALSE}

#Field Crops
#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100359-eng.zip")

field_crop_raw <- read_csv("Data/Food/Production/Crop/32100359.csv")

grain_legume <- as_tibble(field_crop_raw)%>% 
  rename(StatCan_name = "Type of crop")%>%
  filter(REF_DATE %in% (years))

#Potatoes
#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100358-eng.zip")
potatoes_raw <- read_csv("Data/Food/Production/Crop/32100358.csv")

potato <- as_tibble(potatoes_raw)%>%
  mutate("StatCan_name" = "Potatoes")%>%
  filter(REF_DATE %in% (years))

#Fruits
#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100364-eng.zip")
fruits_raw <- read_csv("Data/Food/Production/Crop/32100364.csv")

fruit <- as_tibble(fruits_raw)%>%
  separate(Commodity, sep=' \\[', into=c("name", "number"))%>%
  separate(name, sep='Fresh ', into=c("prefix", "StatCan_name"))%>%
  #NAs "total fresh fruit" and "other fresh fruit nes"
  drop_na(StatCan_name)%>%
  filter(REF_DATE %in% (years))

#Vegetables
#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100365-eng.zip",)
vegetables_raw <- read_csv("Data/Food/Production/Crop/32100365.csv") 

vegetable <- as_tibble(vegetables_raw)%>%
  separate(Commodity, sep=' \\[', into=c("name", "number"))%>%
  separate(name, sep='Fresh ', into=c("prefix", "StatCan_name"))%>%
  #NAs are from , "total fresh veg", "other fresh veg" etc with no number
  drop_na(StatCan_name)%>%
  filter(REF_DATE %in% (years))

## get crop areas in ha, average over 3 years, and bind together ##
grain_legume_area <- grain_legume%>% 
  filter(`Harvest disposition` == "Harvested area (hectares)")%>%
  rename("area_ha" = VALUE)%>%
  replace_na(list(area_ha = 0))%>%
  group_by(GEO, StatCan_name)%>%
  summarise(area_ha = mean(area_ha))

potato_area <- potato%>%
  filter(`Area, production and farm value of potatoes` == "Harvested area, potatoes")%>%
  #convert acres to hectares
  mutate(area_ha = VALUE/2.471)%>%
  replace_na(list(area_ha = 0))%>%
  group_by(GEO, StatCan_name)%>%
  summarise(area_ha = mean(area_ha))

fruit_area <- fruit%>%
  filter(Estimates == "Bearing area", UOM == "Hectares")%>%
  rename("area_ha" = VALUE)%>%
  replace_na(list(area_ha = 0))%>%
  select(StatCan_name, GEO, area_ha)%>%
  group_by(GEO, StatCan_name)%>%
  summarise(area_ha = mean(area_ha))

vegetable_area <- vegetable%>%
  filter(Estimates == "Area harvested (hectares)")%>%
  rename("area_ha" = VALUE)%>%
  replace_na(list(area_ha = 0))%>%
  select(StatCan_name, GEO, area_ha)%>%
  group_by(GEO, StatCan_name)%>%
  summarise(area_ha = mean(area_ha))

crop_area <- bind_rows(grain_legume_area, potato_area, fruit_area, vegetable_area)%>%
  filter(StatCan_name %in% crop_list,
         GEO %in% c("Alberta", "British Columbia", "Saskatchewan", "Manitoba", "Ontario", "Quebec", "Prince Edward Island", "Nova Scotia", "Newfoundland and Labrador", "New Brunswick"))%>%
  filter(area_ha > 100)

## get crop production in kg, average over 3 years, and bind together ##
grain_legume_prod <- as_tibble(grain_legume)%>% 
  filter(`Harvest disposition` == "Production (metric tonnes)")%>%
  mutate(yield_kg = VALUE*1000)%>%
  replace_na(list(yield_kg = 0))%>%
  select(StatCan_name, GEO, yield_kg)%>%
  group_by(GEO, StatCan_name)%>%
  summarise(yield_kg = mean(yield_kg))

potato_prod <- as_tibble(potato)%>%
  filter(`Area, production and farm value of potatoes` == "Production, potatoes")%>%
  #convert hundredweight * 1000 to kg
  mutate(yield_kg = VALUE*50.8*1000)%>%
  replace_na(list(yield_kg = 0))%>%
  select(StatCan_name, GEO, yield_kg)%>%
  group_by(GEO, StatCan_name)%>%
  summarise(yield_kg = mean(yield_kg))

fruit_prod <- as_tibble(fruit)%>%
  filter(Estimates == "Marketed production", UOM == "Metric tonnes")%>%
  mutate(yield_kg = VALUE*1000)%>%
  replace_na(list(yield_kg = 0))%>%
  select(StatCan_name, GEO, yield_kg)%>%
  group_by(GEO, StatCan_name)%>%
  summarise(yield_kg = mean(yield_kg))

vegetable_prod <- as_tibble(vegetable)%>%
  filter(Estimates == "Marketed production (metric tonnes)")%>%
  mutate(yield_kg = VALUE*1000)%>%
  replace_na(list(yield_kg = 0))%>%
  select(StatCan_name, GEO, yield_kg)%>%
  group_by(GEO, StatCan_name)%>%
  summarise(yield_kg = mean(yield_kg))

crop_prod <- bind_rows(grain_legume_prod, potato_prod, fruit_prod, vegetable_prod)%>%
  filter(StatCan_name %in% crop_list,
         GEO %in% c("Alberta", "British Columbia", "Saskatchewan", "Manitoba", "Ontario", "Quebec", "Prince Edward Island", "Nova Scotia", "Newfoundland and Labrador", "New Brunswick"))%>%
  filter(yield_kg > 1000)
```

# Crop VNF 
VNF = kg N loss/ kg food OR kg N loss/ kg N food
N lost between N inputs and crop harvest (field N), harvest and edible N (procesessing), and household waste

## N inputs 
N inputs = N from fertilizer + N from BNF (not manure since it's recycled)

### Fertilizer N
based on fertilizer sales adjusted by crop recommended rate
```{r N_fertilizer, echo=FALSE, message = FALSE}
#Fertilizer Sales N
#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100039-eng.zip", "Data/Food/Fertilizer/32100039-eng.zip")
fert_sales_raw <- read_csv("Data/Food/Fertilizer/32100039.csv")

N_fert_sales <- as_tibble(fert_sales_raw)%>%
  separate(`REF_DATE`, sep="/", into=c("REF_DATE", "month"))%>%
  filter(`Fertilizer nutrient content` == "Nitrogen",
         Period == "July to June",
         #get whole year, intead of just growing season
         REF_DATE %in% (years))%>%
  #BC missing a value for 2018, used average of previous two years
  replace_na(list(VALUE = 24.5))%>%
  group_by(GEO, `Fertilizer nutrient content`, UOM, SCALAR_FACTOR)%>%
  summarise(quantity = mean(VALUE))%>%
  mutate(sales_N_kg = quantity*1000000)

#Recommended N Application Rates
#from @yangDevelopment2007
#added wheat as average of spring and winter (almost the same)
#added atlantic province recommendations seperately
recommended_rates <- read_excel("Data/Food/Fertilizer/recommended_fertilizer.xlsx")%>%
  mutate("Canada" = (rowSums(.[2:7])/7))%>%
  gather(GEO, Rate_kg_ha, `British Columbia`:`Canada`)

#Fertilizer N Application adjusted
#actual N applied on each crop estimated by adjusting the recommended rate for each crop type by the ratio of total N sold provincially(kg) to the total N if recommended rates were used
#@huffmanEstimation2008, @yangDevelopment2007
#Due to a lack of data for some recommended fertilizer rates and sales data, PEI, NB NFLD and NS were grouped together as the Atlantic Provinces, the avg fertilizer rate was applied to each province 
N_rec_fert_crop <- mutate(crop_area, key_rec_fert = case_when(StatCan_name %in% vegetable_list ~ "Vegetables",
                                                          StatCan_name %in% c("blueberries", "raspberries", "strawberries", "cranberries", "saskatoon berries", "blackberries", "currants", "haskaps") ~ "Berries",
                                                          StatCan_name %in% c("apples", "peaches", "pears", "plums and prune plums", "nectarines", "apricots", "sour cherries", "sweet cherries") ~ "Tree fruits",
                                                          StatCan_name %in% c("Barley", "Canary seed", "Rye, all", "Triticale") ~ "Other field",
                                                          StatCan_name %in% c("Beans, all dry (white and coloured)", "Chick peas", "Faba beans", "Lentils", "Peas, dry") ~ "Pulses",
                                                          StatCan_name == "Canola (rapeseed)" ~ "Canola",
                                                          StatCan_name == "Flaxseed" ~ "Flax seed",
                                                          StatCan_name == "Sunflower seed" ~ "Sunflower",
                                                          StatCan_name == "Sugar beets" ~ "Sugar beet",
                                                          StatCan_name == "Wheat, all" ~ "Wheat",
                                                          StatCan_name == "grapes" ~ "Grapes",
                                                          TRUE ~ StatCan_name))%>%
  #StatCan crop names were matched to crop categories for recommended fertilization rates
  left_join(recommended_rates, by  = c("key_rec_fert" = "Crop", "GEO"="GEO"))%>%
  #total *recommended* fertilizer use for a given crop in a province
  mutate(N_rec_crop_kg = area_ha*Rate_kg_ha)%>%
  mutate(key_prov_fert = case_when(GEO %in% c("Prince Edward Island", "New Brunswick", "Nova Scotia", "Newfoundland and Labrador") ~ "Atlantic provinces",
                                   TRUE ~ GEO))

#total *recommended* fertilizer use by province
N_rec_fert_prov <- mutate(N_rec_fert_crop, key_prov_fert = case_when(GEO %in% c("Prince Edward Island", "New Brunswick", "Nova Scotia", "Newfoundland and Labrador") ~ "Atlantic provinces",
                                                                     TRUE ~ GEO))%>%
  group_by(key_prov_fert)%>%
  summarize(Total_N_rec_prov = sum(N_rec_crop_kg))

N_adjusted_fert <- left_join(N_rec_fert_crop, N_rec_fert_prov)%>%
  left_join(N_fert_sales, by = c("key_prov_fert" = "GEO"))%>%
  #adjusted by sale/recommended ratio
  mutate(N_applied_crop_kg = (N_rec_crop_kg * sales_N_kg / Total_N_rec_prov))%>%
  #calculated the difference between what the total N value should be if recommended rates were being used, and sales-based values
  mutate(Diff_sales_rec = N_applied_crop_kg - N_rec_crop_kg)
```

### BNF N 
Nitrogen from BNF = total crop N (root, residue and product N) * % fixed from atmosphere used vaules from @karimiupdated2020
include alfalfa?
```{r N_BNF, echo=FALSE, message = FALSE}
#BNF rates, HI and residues from @karimi2020
HI_Nconc_BNF_raw <- read_excel("Data/Food/Production/Crop/HI_Nconc_BNF.xlsx")

HI_Nconc_BNF <- as_tibble(HI_Nconc_BNF_raw)

#BNF fixation
N_BNF <- mutate(crop_prod, key = case_when(StatCan_name %in% c("apples", "peaches", "pears", "plums and prune plums", "nectarines", "apricots", "sour cherries", "sweet cherries") ~ "Tree fruit",
                                           StatCan_name %in% c("blueberries", "raspberries", "strawberries", "cranberries", "saskatoon berries", "blackberries", "currants", "haskaps", "grapes") ~ "Berries and grapes",
                                           StatCan_name %in% vegetable_list ~"Vegetables",
                                           StatCan_name %in% c("Buckwheat") ~ "Other field crops",
                                           TRUE ~ StatCan_name))%>%
  left_join(HI_Nconc_BNF, by = c("key" = "Crop"))%>%
  mutate(yield_DM_kg = yield_kg * ((1-(`H20 content (%w/w)`/100))),
         yield_N_kg = yield_DM_kg * (`N conc res (%DM)`/100),
         residue_kg = yield_DM_kg * ((1 - HI)/HI),
         residue_N_kg = residue_kg * `N conc res (%DM)`/ 100,
         root_kg = `Below Ground Residue (% of DM harvest)`/(100 - `Below Ground Residue (% of DM harvest)`) * (yield_kg + residue_kg),
         root_N_kg = root_kg * (`N conc root (%DM)`/100),
         N_BNF_kg = (yield_N_kg + residue_N_kg + root_N_kg) * (`%BNFA`/100))%>%
  replace_na(list(N_BNF_kg=0))
```

### TOTAL N INPUTS
```{r N_total_input, echo=FALSE, message = FALSE}
N_input <- left_join(N_adjusted_fert, N_BNF, by = c("GEO"="GEO", "StatCan_name"="StatCan_name"))%>%
  mutate(total_new_N_kg = N_applied_crop_kg + N_BNF_kg)%>%
  select(-c(key_prov_fert, "Fertilizer nutrient content", UOM, SCALAR_FACTOR, quantity))
```

## Crop yield N and field N losses
Field N loss = N fertilizer + N BNF + N loss crop residue - crop N export - residue N export (feed?) - denitrification
assumed that remaining residue and decomposing root material are recycled and reabsorbed by the growing crop, also very minor flow @karimiupdated2020
they assume 10% of remaining organic N in soil is denitrified (sensitivity analysis?), 1:1 N20 to N2 @yang2007

```{r N_field_loss, echo=FALSE, message = FALSE}

#Yield N concentrations and allocations of products and aboveground residues taken from @karimiupdated2020
residue_allocation <- read_excel("Data/Food/Production/Crop/residue_allocation.xlsx")

#crop StatCan names matched to N concentration names
N_field_loss <- left_join(N_input, residue_allocation, by = c("key" = "Crop"))%>%
  mutate(residue_N_export_kg = case_when(key == "Tree fruit" ~ 0,
                                     key == "Berries and grapes" ~ 0,
                                     TRUE ~ residue_N_kg * `Residue: Export %`),
         product_N_export_kg = yield_N_kg * (`Product: Livestock %` + `Product: Export %`),
         denitrification_N_kg = residue_N_kg * `Residue: Soil %` * 0.10,
         N_loss_field_kg = total_new_N_kg - product_N_export_kg - residue_N_export_kg - denitrification_N_kg
  )%>%
  #to get rid of oddness in surveys, e.g. some crops in some provinces have an area but no harvest or vice versa
  filter(area_ha > 0,
         yield_kg > 0)%>%
  select(-c(4:8, key, "Source.x", "Source.y"))
#there are some negative values. Soil N mining? 
```

## Edible N and processing losses
```{r N_processing_loss, echo=FALSE, message = FALSE}
#Processing, packaging and distribution waste values were taken from Leach 2012/FAO (Used same N conc values @karimi2020 for consistency (Lassaletta's slightly different).
#N_Cont_Lassaletta <- read_excel("Data/Food/10533_2013_9923_MOESM1_ESM.xlsx", skip=1)
#Could use values from 2010 StatsCan estimates of food losses during storage and transport, across major food groups in Canada.

#leach 2020/FAO 
food_processing_waste <- read_excel("Data/Food/Food_waste/food_waste_FAO.xlsx")

#Processing loss
N_crop_process <- mutate(N_field_loss, key_process = case_when(StatCan_name %in% grain_list ~ "cereals",
                                                 StatCan_name %in% oilseed_list ~ "oilseeds",
                                                 StatCan_name %in% legume_list ~ "pulses",
                                                 StatCan_name %in% root_list ~ "roots",
                                                 StatCan_name %in% fruit_list ~ "fruits",
                                                 StatCan_name %in% vegetable_list ~ "vegetables",
                                                 TRUE ~ StatCan_name))%>%
  left_join(food_processing_waste, by = c("key_process" = "Percent N lost"))%>%
  #processing N loss
  mutate(retail_N_kg = yield_N_kg * (1-`Processing and packaging`),
         retail_kg = yield_kg * (1-`Processing and packaging`),
         N_loss_processing_waste_kg = yield_N_kg - retail_N_kg,
         #retail N loss
         edible_N_kg = retail_N_kg * (1-`Distribution: Supermarket Retail`),
         edible_kg = retail_kg * (1-`Distribution: Supermarket Retail`),
         N_loss_retail_waste_kg = retail_N_kg - edible_N_kg,
         #household N loss & N consumed
         consumed_N_kg = edible_N_kg * (1-`Household Waste`),
         consumed_kg = edible_kg * (1-`Household Waste`),
         N_loss_household_waste_kg = edible_N_kg - consumed_N_kg)%>%
  rename("food_group"= "key_process")
```

## VNF Food Crop
```{r VNF_food_crop, echo=FALSE, message = FALSE}
VNF_food_crop_prov <- N_crop_process%>%
  mutate(Total_N_loss_kg = N_loss_field_kg + N_loss_processing_waste_kg + N_loss_retail_waste_kg + N_loss_household_waste_kg,
         #VNF
         VNF_kgN_kg = (Total_N_loss_kg / edible_kg),
         VNF_kgN_kgN = (Total_N_loss_kg / edible_N_kg))%>%
  group_by(GEO, food_group)%>%
  summarise(`VNF_kgN_kg` = mean(`VNF_kgN_kg`), `VNF_kgN_kgN` = mean(`VNF_kgN_kgN`))%>%
  drop_na()
  #write_csv(VNF_crop_avg, file.path("Results_Images/VNF_food_group.csv"))

VNF_food_crop_CAN <- VNF_food_crop_prov%>%
  group_by(food_group)%>%
  summarise(`VNF_kgN_kg` = mean(`VNF_kgN_kg`), `VNF_kgN_kgN` = mean(`VNF_kgN_kgN`))%>%
  mutate(GEO = "Canada")

VNF_food_crop <- bind_rows(VNF_food_crop_prov, VNF_food_crop_CAN)
#write_csv(VNF_crop_avg, file.path("Results_Images/VNF_food_group.csv"))

##GRAPHS AND FUN STUFF##
#variation in VNFs between food groups

ggplot(VNF_food_crop, aes(fill = food_group, y = VNF_kgN_kg, x = food_group))+
  geom_bar(position="stack", stat="identity") +
  facet_wrap(vars(GEO), scales = "free")+
  labs(caption = "Virtual nitrogen factors (kgN / kg) for food crops") +
  scale_fill_manual(values=wes_palette(n=6, name="IsleofDogs1"))+
  theme_classic()+
  theme(axis.title.y = element_blank(), 
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_blank(),
        plot.caption = element_text(hjust = 0))
  
#ggsave("Results_Images/VNF_crop_CAN.pdf")
```

# Meat & animal product VNF
Same as crop VNF with the addition of N lost during the raising of livestock from manure and feed. Based on the population of animals in each province * average manure production and N emissions, average feed amounts and ratios of feed types, N VNF associated with feed, N loss meat processing.
Most of dairy emission including all cows, calves and heifers attributed to milk, about 3% attributed to meat. Most layer emissions attributed to eggs, about 7% attributed to meat (@Sheppard2015). Leach does not separate emissions? Therefore will attribute meat emissions to beef cattle, and milk emission to dairy cattle etc. 

## Animal populations
```{r animal_data, echo=FALSE, message = FALSE}
#note on chicken numbers: there's no info on what percent of slaughter is layers vs broiler chickens. Have # of layers, and total number slaughtered. Therefore we have taken the number of total chickens slaughtered, and subtracted the total number of layers present for that year (since layers have ~1 year lifespan), to estimate number of broilers. 

#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100121-eng.zip")
eggs_raw <- read_csv("Data/Food/Production/Animal/32100119.csv")

layer_prod <- as_tibble(eggs_raw)%>%
  filter(`Production and disposition` %in% c("Disposition of eggs in shell sold for consumption [116111111]", "Average number of layers"))

layer_pop <- layer_prod%>%
  mutate(StatCan_name = case_when(`Production and disposition` == "Average number of layers" ~ "Layers"))%>%
  select(REF_DATE, StatCan_name, GEO, UOM, SCALAR_FACTOR, VALUE)%>%
  drop_na()

#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100117-eng.zip")
poultry_prod_raw <- read_csv("Data/Food/Production/Animal/32100117.csv")
poultry_prod <- as_tibble(poultry_prod_raw)%>%
  filter(`Commodity`== "Chicken (including stewing hen)", `Production and disposition`=="Production, total", Estimates == "Birds")%>%
  mutate("StatCan_name" = "Chickens")%>%
  select(REF_DATE, StatCan_name, GEO, UOM, SCALAR_FACTOR, VALUE)

broiler_pop <- left_join(poultry_prod,layer_pop, by = c("REF_DATE" = "REF_DATE","GEO" = "GEO", "SCALAR_FACTOR" = "SCALAR_FACTOR"))%>%
  filter(StatCan_name.y != "Eggs")%>%
  mutate(VALUE = `VALUE.x`-`VALUE.y`)%>%
  mutate(StatCan_name = "Broilers")%>%
  mutate(UOM = "Birds")%>%
  select(REF_DATE, StatCan_name, GEO, UOM, SCALAR_FACTOR, VALUE)

#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100130-eng.zip")
beef_prod_raw <- read_csv("Data/Food/Production/Animal/32100130.csv")

beef_pop <- as_tibble(beef_prod_raw)%>%
  rename("StatCan_name" = "Livestock")%>%
  filter(`Survey date` == "At January 1", `Farm type` %in% c("On dairy operations", "On beef operations"), !(StatCan_name %in% c("Total cattle", "Total heifers", "Heifers for beef replacement", "Heifers for slaughter")))%>%
  select(REF_DATE, StatCan_name, GEO, UOM, SCALAR_FACTOR, VALUE)

#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100160-eng.zip")
pork_prod_raw <- read_csv("Data/Food/Production/Animal/32100160.csv")

pork_pop <- as_tibble(pork_prod_raw)%>% 
  rename("StatCan_name" = "Livestock")%>%
  filter(`Survey date` == "At January 1", StatCan_name %in% c("Boars, 6 months and over", "Sows and gilts, 6 months and over", 	"All other hogs"))%>%
  select(REF_DATE, StatCan_name, GEO, UOM, SCALAR_FACTOR, VALUE)

animal_pop <- bind_rows(beef_pop, pork_pop, broiler_pop, layer_pop)%>%
  filter(REF_DATE %in% years)%>%
  drop_na(VALUE)%>%
  group_by(GEO, StatCan_name, UOM, SCALAR_FACTOR)%>%
  summarise(VALUE = mean(VALUE))

```

## Manure N
Manure excretion emissions and storage losses were based on data published by @huffmanEstimation2008, which are based on provincial feed and manure storage practices. Need to think about manure recycling. Do I bother including it since it's recycled and therefore not new N?

```{r N_manure, echo=FALSE, message = FALSE}

N_manure_rate_raw <- read_excel("Data/Food/Production/Animal/manure.xlsx")

N_manure_rate <- N_manure_rate_raw%>% 
  as_tibble()%>%
  mutate("Canada" = (rowSums(.[2:12])/10))%>%
  gather(Province, `% on pasture`, `British Columbia`:`Canada`, factor_key = TRUE)

#Huffman 2008
storage_loss_raw <- read_excel("Data/Food/Production/Animal/manure_storage.xlsx")

storage_loss <- storage_loss_raw%>%
  as_tibble()%>%
  gather(Animal, `N% after storage`, `Poultry`:`Others`, factor_key = TRUE)
 
stor_can_avg <- storage_loss%>%
  group_by(Animal)%>%
  summarise(Canada = mean(`N% after storage`))%>%
  gather(Province, `N% after storage`, -1, factor_key = TRUE)

storage_loss <- bind_rows(storage_loss, stor_can_avg)

N_manure <- animal_pop%>%
  mutate(key_manure = case_when(StatCan_name == "All other hogs" ~ "Hogs",
                              StatCan_name == "Beef cows" ~ "Beef cattle",
                              StatCan_name == "Boars, 6 months and over"~ "Boars",
                              StatCan_name == "Bulls, 1 year and over" ~ "Bulls",
                              StatCan_name == "Calves, under 1 year"~ "Calves",
                              StatCan_name == "Dairy cows"  ~ "Dairy cows",
                              StatCan_name == "Heifers for dairy replacement"~ "Heifers",
                              StatCan_name == "Sows and gilts, 6 months and over"~ "Sows",
                              StatCan_name == "Steers, 1 year and over" ~ "Steers",
                              StatCan_name == "Total beef heifers"~ "Heifers",
                              StatCan_name == "Layers"~ "Laying hens",
                              TRUE ~ StatCan_name),
         key_storage = case_when(StatCan_name == "All other hogs" ~ "Pigs",
                              StatCan_name == "Beef cows" ~ "Cattle",
                              StatCan_name == "Boars, 6 months and over"~ "Pigs",
                              StatCan_name == "Bulls, 1 year and over" ~ "Cattle",
                              StatCan_name == "Calves, under 1 year"~ "Cattle",
                              StatCan_name == "Dairy cows"  ~ "Cattle",
                              StatCan_name == "Heifers for dairy replacement"~ "Cattle",
                              StatCan_name == "Sows and gilts, 6 months and over"~ "Pigs",
                              StatCan_name == "Steers, 1 year and over" ~ "Cattle",
                              StatCan_name == "Total beef heifers"~ "Cattle",
                              StatCan_name == "Layers"~ "Poultry",
                              StatCan_name == "Broilers"~ "Poultry",
                         TRUE ~ StatCan_name),
         food_group = case_when(StatCan_name == "All other hogs" ~ "Pork",
                              StatCan_name == "Beef cows" ~ "Beef",
                              StatCan_name == "Boars, 6 months and over"~ "Pork",
                              StatCan_name == "Bulls, 1 year and over" ~ "Beef",
                              StatCan_name == "Calves, under 1 year"~ "Beef",
                              StatCan_name == "Dairy cows"  ~ "Milk",
                              StatCan_name == "Heifers for dairy replacement"~ "Milk",
                              StatCan_name == "Sows and gilts, 6 months and over"~ "Pork",
                              StatCan_name == "Steers, 1 year and over" ~ "Beef",
                              StatCan_name == "Total beef heifers"~ "Beef",
                              StatCan_name == "Layers"~ "Eggs",
                              StatCan_name == "Broilers"~ "Chicken",
                         TRUE ~ StatCan_name))%>%
  left_join(N_manure_rate, by = c("key_manure" = "Animal", "GEO" = "Province"))%>%
  left_join(storage_loss, by = c("key_storage" = "Animal", "GEO" = "Province"))%>%
  mutate(N_loss_manure_kg = ((VALUE - (`% on pasture`/100)) * 1000 * `Kg N / head / yr` * (`N% after storage`/100))) 
#not sure what to do about pasture check Hoffman
```

## Feed VNF
```{r VNF_feed, echo=FALSE, message = FALSE}
VNF_feed <- left_join(N_field_loss, N_crop_process)%>%
  filter(StatCan_name %in% feed_crop_list)%>%
  mutate(edible_kg = case_when(StatCan_name == "Tame hay" ~ yield_kg,
                               TRUE ~ yield_kg * (1-`Processing and packaging`)),
         edible_kg_DM = edible_kg * (1-(`H20 content (%w/w)`/100)),
         edible_N_kg = edible_kg_DM * (`N conc prod (%DM)`/100),
         #N loss through feed processing
         N_loss_processing_N_kg = yield_N_kg - edible_N_kg,
         #Total N loss
         Total_N_loss_kg = N_loss_processing_N_kg + N_loss_field_kg,
         #VNF 
         VNF_kgN_kg = (Total_N_loss_kg / edible_kg),
         VNF_kgN_kgN = (Total_N_loss_kg / edible_N_kg))%>%
  filter(GEO == "Canada")%>%
  filter(StatCan_name != "Soybeans") #doing something strange also not used in feed (Hoffman?)
#write_csv(VNF_feed, file.path("Data/Results/VNF_feed.csv"))

## Graphing ##
ggplot(VNF_feed, aes(y = VNF_kgN_kg, x = StatCan_name, fill = StatCan_name)) +
  geom_bar(position="stack", stat="identity") +
  labs(caption = "Virtual nitrogen factors (kgN / kg) for feed crops") +
  scale_fill_manual(values=wes_palette(n=6, name="IsleofDogs1"))+
  theme_classic()+
  theme(axis.title.y = element_blank(), 
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_blank(),
        plot.caption = element_text(hjust = 0))

#ggsave("Results_Images/VNF_feed_avg.pdf")
```

## VN from feed
Feed diet fractions were based on farm survey data published by @sheppardLinkage2015. 
```{r N_feed, echo=FALSE, message = FALSE}
feed_ratio <- read_excel("Data/Food/Production/Animal/Feed_ratios.xlsx")
  
#adjust StatCan feedcrops to match sheppards categories
avg_VNF_feed <- VNF_feed%>%
  mutate(feed_group = case_when(StatCan_name == "Barley" ~ "Grain",
                                StatCan_name == "Corn for silage" ~ "Corn for silage",
                                StatCan_name == "Oats"~ "Grain",
                                StatCan_name == "Spring wheat" ~ "Grain",
                                StatCan_name == "Tame hay" ~ "Hay",
                                StatCan_name == "Winter wheat" ~ "Grain"
  ))%>%
  group_by(feed_group)%>%
  summarise(VNF_kgFeed = mean(VNF_kgN_kg))%>%
  pivot_wider(names_from = feed_group, values_from = VNF_kgFeed)

VN_feed <- animal_pop%>%
  #match StatCanName to Hoffman groups
  mutate(key_feed = case_when(StatCan_name == "All other hogs" ~ "Grower",
                              StatCan_name == "Beef cows" ~ "Beef cow",
                              StatCan_name == "Boars, 6 months and over"~ "Boar",
                              StatCan_name == "Bulls, 1 year and over" ~ "Beef bull",
                              StatCan_name == "Calves, under 1 year"~ "Calves",
                              StatCan_name == "Dairy cows"  ~ "Dairy cow",
                              StatCan_name == "Heifers for dairy replacement"~ "Dairy heifer",
                              StatCan_name == "Sows and gilts, 6 months and over"~ "Sow and gilts",
                              StatCan_name == "Steers, 1 year and over" ~ "Beef steer",
                              StatCan_name == "Total beef heifers"~ "Beef heifer",
                              StatCan_name == "Layers"~ "Layer",
                              StatCan_name == "Broilers"~ "Broiler",
                              TRUE ~ StatCan_name))%>%
  left_join(feed_ratio, by = c("key_feed"="Animal"))%>%
  #total amount of feed
  mutate(feed_kg = VALUE * 1000 * `Feed kg/animal/year`)%>%
  #amount of feed by type
  mutate(grain_kg = feed_kg * `%Grain`)%>%
  mutate(corn_kg = feed_kg * `%Corn for silage`)%>%
  mutate(hay_kg = feed_kg * `%Straw/Hay`)%>%
  #VN from feed by feed type from avg_VNF_feed above
  mutate(VN_feed_kg = ((grain_kg * avg_VNF_feed$Grain )+(corn_kg* avg_VNF_feed$`Corn for silage`)+(hay_kg*avg_VNF_feed$Hay)))

```

## N loss meat processing and edible meat ##
N losses during meat processing were estimated difference between N content of animals slaughtered (from @Leach2012) and N content of meat (N contents of meat from @FAO/Lassaletta).#Only partial data available for animals slaughtered at the provincial or national scale (available for chicken, but not pork or beef, which are only available at the national scale and only as total animal), 
Used Canadian meat conversion factors published by @sheppardLinkage2015 * provincial livestock populations to estimate animal slaughtered
How close were they to national values?
N losses during meat processing were estimated using N content of live animals from @Leach2012, average processing losses from @sheppardLinkage2015, and N contents of meat from @FAO/Lassaletta.

```{r N_process_meat, echo=FALSE, message = FALSE}

#@sheppardLinkage2015
meat_process_conv <- read_excel("Data/Food/Production/Animal/animal_processing_conversion.xlsx")

N_Cont_food <- read_excel("Data/Food/10533_2013_9923_MOESM1_ESM.xlsx", skip=1)

N_meat_process <- animal_pop%>%
  left_join(meat_process_conv, by = c("StatCan_name" = "StatCan_description"))%>%
  drop_na(Conversion_factor)%>%
  #this is to check against national stats
  mutate(animals_slaughtered = VALUE * 1000 * `Fraction Population slaughtered`)%>%
  mutate(meat_type = case_when(StatCan_name == "All other hogs"  ~ "Pork",
                               StatCan_name == "Beef cows" ~ "Beef meat",
                               StatCan_name == "Boars, 6 months and over" ~ "Pork",
                               StatCan_name == "Broilers" ~ "Chicken meat",
                               StatCan_name == "Bulls, 1 year and over"  ~ "Beef meat",
                               StatCan_name == "Calves, under 1 year" ~ "Beef meat",
                               StatCan_name == "Dairy cows" ~ "Beef meat",
                               StatCan_name == "Layers" ~ "Chicken meat",
                               StatCan_name == "Sows and gilts, 6 months and over" ~ "Pork",
                               StatCan_name == "Steers, 1 year and over" ~ "Beef meat",
                               StatCan_name == "Total beef heifers" ~ "Beef meat",
                               TRUE ~ StatCan_name))%>%
  #animal N content from @Leach2020
  mutate(animal_N_cont = case_when(meat_type == "Beef meat" ~ 0.02,
                                   meat_type == "Pork" ~  0.02,
                                   meat_type == "Chicken meat" ~ 0.023))%>%
  #meat production N loss
  mutate(animal_N_kg = animals_slaughtered*`Weight at slaughter (kg/animal)` * animal_N_cont)%>%
  mutate(meat_yield_kg = case_when(UOM == "Birds" ~ animals_slaughtered * `Weight at slaughter (kg/animal)` * `Carcass/Live (kg/kg)`,
                                    UOM == "Head" ~ animals_slaughtered * `Weight at slaughter (kg/animal)`* `Carcass/Live (kg/kg)`))%>%
  mutate(meat_edible_kg = case_when(UOM == "Birds" ~ meat_yield_kg * `Retail/Carcass (kg/kg)`,
                                  UOM == "Head" ~ meat_yield_kg * `Retail/Carcass (kg/kg)`,
                                  UOM == "Layers" ~ meat_yield_kg * `Retail/Carcass (kg/kg)`))%>%
  mutate(meat_name = case_when(meat_type == "Beef meat" ~ "Meat-CattleBoneless(Beef&Veal)",
                               TRUE ~ meat_type))%>%
  left_join(N_Cont_meat, by = c("meat_name" = "ITEM"))%>%
  mutate(meat_edible_N_kg = meat_edible_kg * `%N content`/100)%>%
  mutate(meat_yield_N_kg = meat_yield_kg * `%N content`/100)%>%
  mutate(N_loss_processing_kg = animal_N_kg - meat_edible_N_kg)%>%
  #household N loss from Leach/FAO
  mutate(meat_consumed_kg = meat_edible_kg * (1-0.11),
         meat_consumed_N_kg = meat_edible_N_kg * (1-0.11),
         N_loss_household_N_kg = meat_edible_N_kg - meat_consumed_N_kg,
         N_loss_household_kg = meat_edible_kg - meat_consumed_kg,
         N_domestic_consumed_N_kg = meat_edible_N_kg - N_loss_household_N_kg,
         N_domestic_consumed_kg = meat_edible_kg - N_loss_household_kg)
```

## N loss processing and edible animal products 
```{r, N_process_animal_product, echo=FALSE, message = FALSE}

N_eggs <- eggs_raw%>%
  as_tibble()%>%
  filter(`Production and disposition` %in% c("Disposition of eggs in shell sold for consumption [116111111]",
                                             "Disposition of eggs in shell, leakers and rejects [116111311]"),
         REF_DATE %in% years)%>%
  mutate(quantity_kg = VALUE * 12 * 1000 * 0.056)%>% #avg large egg weight
  select(REF_DATE, GEO, `Production and disposition`, quantity_kg)%>%
  pivot_wider(names_from = `Production and disposition`, values_from = quantity_kg)%>%
  mutate(yield_N_kg = `Disposition of eggs in shell sold for consumption [116111111]` * 0.0172, #from Lasaletta 
         N_loss_processing_kg = `Disposition of eggs in shell, leakers and rejects [116111311]` * 0.0172,
         edible_N_kg = yield_N_kg - N_loss_processing_kg,
         edible_kg = `Disposition of eggs in shell sold for consumption [116111111]` - `Disposition of eggs in shell, leakers and rejects [116111311]`,
         consumed_kg = edible_kg,
         consumed_N_kg = edible_N_kg,
         food_group = "Eggs")%>%
  left_join(N_manure)
         VNF_kgN_kg = (N_loss_manure_kg + VN_feed_kg + N_loss_processing_kg + N_loss_household_kg) / N_domestic_consumed_kg,
         VNF_meat_kgN_kgN = (N_loss_manure_kg + VN_feed_kg + N_loss_processing_kg + N_loss_household_kg) / N_domestic_consumed_N_kg))%>%
  filter(Province == "Canada")%>%
  group_by(food_group)%>%
  summarise(VNF_meat_kgN_kg = mean(VNF_meat_kgN_kg), VNF_meat_kgN_kgN = mean(VNF_meat_kgN_kgN))

  
# included Milk sold for industrial purposes (for cheese yogurt, icecream etc)?
milk_raw <- read_csv("Data/Food/Production/Animal/32100113.csv")%>%
  as_tibble()%>%
  separate(`REF_DATE`, sep="-", into=c("year", "month"))

milk_raw$month = as.double(milk_raw$month)
milk_raw$year = as.double(milk_raw$year)

N_milk <- milk_raw%>%
  filter(month == 1,
         year %in% years,
         `Dairy distribution` == "Milk sold off farms, total")%>%
  mutate(food_group = "milk")%>%
  left_join(food_processing_waste, by = c (food_group = "Percent N lost"))%>%
  mutate(yield_kg = VALUE * 1000,
         yield_N_kg = VALUE * 1000 * 0.00528, #from Lasaletta cow milk whole fresh
         retail_N_kg = yield_N_kg * (1-`Processing and packaging`),
         retail_kg = yield_kg * (1-`Processing and packaging`),
         N_loss_processing_N_kg = yield_N_kg - retail_N_kg,
         #retail N loss
         edible_N_kg = retail_N_kg * (1-`Distribution: Supermarket Retail`),
         edible_kg = retail_kg * (1-`Distribution: Supermarket Retail`),
         N_loss_retail_N_kg = retail_N_kg - edible_N_kg,
         #household N loss & N consumed
         consumed_N_kg = edible_N_kg * (1-`Household Waste`),
         consumed_kg = edible_kg * (1-`Household Waste`),
         N_loss_household_N_kg = edible_N_kg - consumed_N_kg)



```

## VNF Meat and animal products
```{r, echo=FALSE, message = FALSE}
VNF_meat <-  left_join(N_manure, VN_feed)%>%
  left_join(N_meat_process)%>%
  filter(food_group %in% c("Beef", "Pork", "Chicken"))%>%
  mutate(VNF_meat_kgN_kg = (N_loss_manure_kg + VN_feed_kg + N_loss_processing_kg + N_loss_household_kg) / N_domestic_consumed_kg,
         VNF_meat_kgN_kgN = (N_loss_manure_kg + VN_feed_kg + N_loss_processing_kg + N_loss_household_kg) / N_domestic_consumed_N_kg)%>%
  filter(Province == "Canada")%>%
  group_by(food_group)%>%
  summarise(VNF_meat_kgN_kg = mean(VNF_meat_kgN_kg), VNF_meat_kgN_kgN = mean(VNF_meat_kgN_kgN))



```

## Food Supply Data
```{r, echo=FALSE, message = FALSE}
food_supply <- read_csv("Data/Food/Supply/32100053.csv")%>%
  rename("year" = "REF_DATE", "Province"= "GEO")

```


# Food Consumption
```{r, echo=FALSE, message = FALSE}
food_consum_raw <- read_csv("Data/Food/Supply/32100053.csv")

food_consum_kg <- food_consum_raw%>%
  filter(`Supply and disposition`== "Domestic disappearance")%>%
  mutate(quantity_kg = VALUE * 1000000)%>%
  filter(REF_DATE %in% years)
```



```{r, echo=FALSE, message = FALSE}


```


