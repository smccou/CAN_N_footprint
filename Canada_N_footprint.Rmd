---
title: "Sub-national nitrogen footprints from nitrogen budgets provide emission driver context: a Canadian example"

author:
- name: Sibeal McCourt

keywords: Nitrogen, footprint, environmental accounting
wordcount: X

bibliography: [Ch_1.bib]
link-citations: yes

output: html_notebook
---

```{r libraries, echo=FALSE, message = FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(purrr)
library(readxl)
library(stringr)

library(bookdown)
#library(papaja)

library(kableExtra)
library(ggpubr)
library(ggplot2)
library(scales)
library(forcats)
library(RColorBrewer)

```

```{r Scoping, echo=FALSE, message = FALSE}
years = c(2016, 2017, 2018)

prov_code <- matrix(c(1, "Canada", 10, "Newfoundland Labrador", 11,	"Prince Edward Island", 12,	"Nova Scotia", 13, "New Brunswick", 24, "Quebec", 35, 	"Ontario", 46,	"Manitoba", 47, "Saskatchewan", 48, "Alberta", 59, "British Columbia"), ncol=2, byrow = TRUE)
colnames(prov_code) <- c("GEO_code", "GEO")
prov_code <- as_tibble(prov_code)
prov_code$GEO_code <- as.numeric(prov_code$GEO_code)

#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/17100009-eng.zip")
prov_pop <- read_csv("Data/Population/17100009.csv")%>%
  as_tibble%>%
  separate(REF_DATE, sep="-", into=c("year", "month"))%>%
  filter(month == "01")%>%
  select(year, GEO, VALUE)%>%
  mutate(as.integer(year))%>%
  filter(year %in% years)%>%
  group_by(GEO)%>%
  summarize(Population = mean(VALUE))
```

```{r Energy, echo=FALSE, message = FALSE}

#download.file("http://data.ec.gc.ca/data/substances/monitor/canada-s-air-pollutant-emissions-inventory/EN_APEI-Can-Prov_Terr.csv"
APEI_energy <- read_csv("Data/Energy_APEI_GHG/EN_APEI-Can-Prov_Terr.csv")%>%
  as_tibble()%>%
  select(Year, Region, Source, Sector, `NOX (t)`, `NH3 (t)`)%>%
  filter(is.na(Sector))%>% #removes double counts of sectors/sources
  mutate(Region = case_when(Region == "AB" ~ "Alberta",
                            Region == "BC" ~ "British Columbia",
                            Region == "MB" ~ "Manitoba",
                            Region == "NB" ~ "New Brunswick",
                            Region == "NL" ~ "Newfoundland and Labrador",
                            Region == "NS" ~ "Nova Scotia",
                            Region == "ON" ~ "Ontario",
                            Region == "PE" ~ "Prince Edward Island",
                            Region == "QC" ~ "Quebec",
                            Region == "SK" ~"Saskatchewan"))%>%
  mutate(Source = case_when(Source == "Ore and Mineral Industries" ~ "Construction and other industry",
                            Source == "Oil and Gas Industry" ~ "Oil and Gas Industry",
                            Source == "Electric Power Generation (Utilities)" ~ "Electricity Generation",
                            Source == "Manufacturing" ~ "Construction and other industry",
                            Source == "Transportation and Mobile Equipment" ~ "Transport",
                            Source == "Commercial / Residential / Institutional" ~ "Commercial/Residential/Institutional",
                            Source == "Incineration and Waste" ~ "Incineration and Waste",
                            Source == "Paints and Solvents" ~ "Other",
                            Source == "Dust" ~ "Other",
                            Source == "Fires" ~ "Other"))%>%
  replace_na(list(`NOX (t)`= 0, `NH3 (t)` = 0))%>%
  mutate(N_kg = ((`NOX (t)` * 1000 * 14.0067 / 46.0055) + (`NH3 (t)` * 1000 * 14.0067 / 17.031)))%>% #convert NOx weights to N, NOx reported as NO2 equivalent 
  drop_na(Source, Region)%>%
  filter(Year %in% years)%>%
  group_by(Region, Source)%>%
  summarise(`N kg/year` = mean(N_kg))

#Canada has only Grand total emissions, so calculated sub categories separately
CAN_APEI <- APEI_energy%>%
  group_by(Source)%>%
  summarise(`N kg/year` = sum(`N kg/year`))%>%
  mutate(Region = "Canada")

APEI_energy <- bind_rows(APEI_energy, CAN_APEI)%>%
  left_join(prov_pop, by = c("Region"="GEO"))%>%
  mutate(`N kg/cap/year` = `N kg/year` / Population)%>%
  select(Region, Source, `N kg/cap/year`,`N kg/year`)

#download.file("http://donnees.ec.gc.ca/data/substances/monitor/canada-s-official-greenhouse-gas-inventory/GHG_IPCC_Can_Prov_Terr.csv"
GHG_energy <- read_csv("Data/Energy_APEI_GHG/GHG_IPCC_Can_Prov_Terr.csv")%>%
  as_tibble()%>%
  select(Year, Region, Category, Unit, N2O)%>%
  #see executive summary file for exaplanation of categories
  mutate(Source = case_when(Category == "Public Electricity and Heat Production" ~ "Electricity Generation",
                            Category == "Petroleum Refining Industries" ~ "Oil and Gas Industry",
                            Category == "Oil and Gas Extraction" ~ "Oil and Gas Industry",
                            Category == "Mining" ~ "Construction and other industry",
                            Category == "Manufacturing Industries" ~ "Construction and other industry",
                            Category == "Construction" ~ "Construction and other industry",
                            Category == "Commercial and Institutional" ~ "Commercial/Residential/Institutional",
                            Category == "Residential" ~ "Commercial/Residential/Institutional",
                            Category == "Transport" ~ "Transport",
                            Category == "Fugitive Sources" ~ "Other",
                            Category == "CO2 Transport and Storage" ~ "Other",
                            Category == "INDUSTRIAL PROCESSES AND PRODUCT USE" ~ "Construction and other industry",
                            Category == "WASTE" ~ "Incineration and Waste"))%>%
  drop_na(Source)%>%
  replace_na(list(N2O = 0))%>%
  mutate(N_kg = N2O *1000000*14.0067/44.013)%>% #convert N20 to N
  filter(Year %in% years)%>%
  group_by(Region, Source)%>%
  summarise(`N kg/year` = mean(N_kg))%>%
  left_join(prov_pop, by = c("Region"="GEO"))%>%
  mutate(`N kg/cap/year` = `N kg/year` / Population)%>%
  select(Region, Source, `N kg/cap/year`, `N kg/year`)

N_energy <- bind_rows(APEI_energy, GHG_energy)%>%
  filter(Source %in% c("Electricity Generation", "Oil and Gas Industry", "Transport", "Commercial/Residential/Institutional"), Region %in% c("Canada", "Newfoundland and Labrador",	"Prince Edward Island",	"Nova Scotia", "New Brunswick", "Quebec", 	"Ontario",	"Manitoba", "Saskatchewan", "Alberta", "British Columbia"))%>%
  group_by(Region, Source)%>%
  summarise(`N kg/cap/year` = sum(`N kg/cap/year`),
            `N kg/year` = sum(`N kg/year`))%>%
  mutate(`N footprint sector` = "Fossil Fuels")%>%
  rename("GEO"="Region", "Subsector"="Source")

```

```{r crop_categorization, echo=FALSE, message = FALSE}
#Names from StatsCan Crop Surveys, with doubles/subcategories removed
field_crop_list = c("Barley", "Beans, all dry (white and coloured)", "Canary seed", "Canola (rapeseed)", "Chick peas", "Corn for grain", "Corn for silage", "Faba beans", "Flaxseed", "Lentils", "Rye, all", "Oats", "Soybeans", "Sugar beets", "Peas, dry", "Sunflower seed", "Tame hay", "Triticale", "Wheat, all")                                          
#removed subcategories/duplicates "Beans, dry white", "Beans, dry coloured", "Rye, all including fall rye remaining" "Rye, fall remaining" "Rye, spring" "Rye, fall seeded in previous fall" "Wheat, all including winter wheat remaining" "Wheat, durum" "Wheat, spring" "Wheat, Canada Western Extra Strong (CWES)" "Wheat, Canada Western Red Spring (CWRS)"  "Wheat, Canada Prairie Spring Red (CPSR) and Canada Prairie Spring White (CPSW)" "Wheat, Canada Western Soft White Spring (CWSWS)" "Wheat, other spring" "Wheat, winter remaining" "Wheat, winter seeded in fall" "Wheat, all excluding durum wheat""Wheat, Canada Western Special Purpose (CWSP)" "Wheat, Canada Western Hard White Spring (CWHWS)" "Wheat, Canada Northern Hard Red (CNHR)" "Wheat, Canada Eastern Red Spring (CERS)"
#removed "Borage seed" "Caraway seed" "Coriander seed" "Mustard seed" "Safflower" "Hemp", "Buckwheat" (no recommended fert rates or no longer reported)

fruit_list = c("apples", "blueberries", "grapes", "peaches", "pears", "plums and prune plums", "raspberries", "strawberries", "nectarines", "sour cherries", "sweet cherries", "cranberries", "haskaps")
#removed subcategories/duplicates "highbush blueberries" "lowbush blueberries" "Labrusca grapes" "vinifera, fresh French hybrid grapes", 
#removed "saskatoon berries" only grown is saskatchewan, no apricots (under 100 ha), black berries, currants

vegetable_survey_list = c("cabbage", "rutabagas and turnips", "beets", "cauliflowers", "sweet corn", "lettuce", "parsnips", "green and wax beans", "carrots", "cucumbers and fresh gherkins (all varieties)", "tomatoes", "green peas", "asparagus", "celery", "dry onions", "spinach", "peppers", "garlic", "broccoli", "Brussels sprouts", "leeks", "pumpkins", "French shallots and green onions", "squash and zucchini")
#removed parsely, regular cabbage" "Chinese cabbage" "watermelons", 'sweet potatoes, rhubarb radishes, asian radishes, kale, eggplant,  

#Food grouping lists
cereals_list = c("Corn for grain", "Rye, all", "Oats", "Triticale", "Wheat, all") #stuff that people eat crops with less than 60% livestock allocation based on Karimi et al 2020 (Table A4)

feed_list = c("Barley", "Corn for silage", "Wheat, all", "Soybeans", "Tame hay") #based on Sheppard

legume_list = c("Beans, all dry (white and coloured)", "Chick peas", "Lentils", "Soybeans", "Peas, dry")

oilseed_list = c("Canola (rapeseed)", "Sunflower seed")

root_list = c("Potatoes", "carrots", "dry onions", "parsnips", "rutabagas and turnips", "beets")

vegetable_list = c("cabbage", "cauliflowers", "sweet corn", "lettuce", "green and wax beans", "cucumbers and fresh gherkins (all varieties)", "tomatoes", "green peas", "asparagus", "celery", "spinach", "peppers", "garlic", "broccoli", "Brussels sprouts", "leeks", "pumpkins", "French shallots and green onions", "squash and zucchini")

food_crop_list = c("Corn for grain", "Rye, all", "Oats", "Triticale", "Wheat, all", "Beans, all dry (white and coloured)", "Chick peas", "Lentils", "Soybeans", "Peas, dry", "Canola (rapeseed)", "Sunflower seed", "Potatoes", "carrots", "dry onions", "parsnips", "rutabagas and turnips", "beets", "cabbage", "cauliflowers", "sweet corn", "lettuce", "green and wax beans", "cucumbers and fresh gherkins (all varieties)", "tomatoes", "green peas", "asparagus", "celery", "spinach", "peppers", "garlic", "broccoli", "Brussels sprouts", "leeks", "pumpkins", "French shallots and green onions", "squash and zucchini", "apples", "blueberries", "grapes", "peaches", "pears", "plums and prune plums", "raspberries", "strawberries", "nectarines", "sour cherries", "sweet cherries", "cranberries")

all_crop_list = c("Corn for grain", "Rye, all", "Oats", "Triticale", "Wheat, all", "Beans, all dry (white and coloured)", "Chick peas", "Lentils", "Soybeans", "Peas, dry", "Canola (rapeseed)", "Sunflower seed", "Potatoes", "carrots", "dry onions", "parsnips", "rutabagas and turnips", "beets", "cabbage", "cauliflowers", "sweet corn", "lettuce", "green and wax beans", "cucumbers and fresh gherkins (all varieties)", "tomatoes", "green peas", "asparagus", "celery", "spinach", "peppers", "garlic", "broccoli", "Brussels sprouts", "leeks", "pumpkins", "French shallots and green onions", "squash and zucchini", "apples", "blueberries", "grapes", "peaches", "pears", "plums and prune plums", "raspberries", "strawberries", "nectarines", "sour cherries", "sweet cherries", "cranberries", "Barley", "Corn for silage", "Faba beans", "Sugar beets", "Tame hay")

#notes 
# canary seed not included in feed or cereals, primarily used for pet food?
# flax seed used for clothing/oil?

animal_list = c("Beef", "Pork", "Chicken", "Milk", "Eggs")

```

```{r crop_data, echo=FALSE, message = FALSE}

#Field Crops
#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100359-eng.zip")
field_crop_survey <- read_csv("Data/Food/Production/Crop/32100359.csv")%>%
  as_tibble()%>% 
  rename(StatCan_name = "Type of crop")%>%
  filter(REF_DATE %in% (years))

#Potatoes
#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100358-eng.zip")
potato_survey <- read_csv("Data/Food/Production/Crop/32100358.csv")%>%
  as_tibble()%>%
  mutate("StatCan_name" = "Potatoes")%>%
  filter(REF_DATE %in% (years))

#Fruits
#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100364-eng.zip")
fruits_survey <- read_csv("Data/Food/Production/Crop/32100364.csv")%>%
  as_tibble()%>%
  separate(Commodity, sep=' \\[', into=c("name", "number"))%>%
  separate(name, sep='Fresh ', into=c("prefix", "StatCan_name"))%>%
  #NAs "total fresh fruit" and "other fresh fruit nes"
  drop_na(StatCan_name)%>%
  filter(REF_DATE %in% (years))

#Vegetables
#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100365-eng.zip",)
vegetables_survey <- read_csv("Data/Food/Production/Crop/32100365.csv")%>%
  as_tibble()%>%
  separate(Commodity, sep=' \\[', into=c("name", "number"))%>%
  separate(name, sep='Fresh ', into=c("prefix", "StatCan_name"))%>%
  #NAs are from , "total fresh veg", "other fresh veg" etc with no number
  drop_na(StatCan_name)%>%
  filter(REF_DATE %in% (years))

## get crop areas in ha, average over 3 years, and bind together ##
field_crop_area <- field_crop_survey%>% 
  filter(`Harvest disposition` == "Harvested area (hectares)")%>%
  rename("area_ha" = VALUE)%>%
  replace_na(list(area_ha = 0))%>%
  group_by(GEO, StatCan_name)%>%
  summarise(area_ha = mean(area_ha))

potato_area <- potato_survey%>%
  filter(`Area, production and farm value of potatoes` == "Harvested area, potatoes")%>%
  #convert acres to hectares
  mutate(area_ha = VALUE/2.471)%>%
  replace_na(list(area_ha = 0))%>%
  group_by(GEO, StatCan_name)%>%
  summarise(area_ha = mean(area_ha))

fruit_area <- fruits_survey%>%
  filter(Estimates == "Bearing area", UOM == "Hectares")%>%
  rename("area_ha" = VALUE)%>%
  replace_na(list(area_ha = 0))%>%
  select(StatCan_name, GEO, area_ha)%>%
  group_by(GEO, StatCan_name)%>%
  summarise(area_ha = mean(area_ha))

vegetable_area <- vegetables_survey%>%
  filter(Estimates == "Area harvested (hectares)")%>%
  rename("area_ha" = VALUE)%>%
  replace_na(list(area_ha = 0))%>%
  select(StatCan_name, GEO, area_ha)%>%
  group_by(GEO, StatCan_name)%>%
  summarise(area_ha = mean(area_ha))

crop_area <- bind_rows(field_crop_area, potato_area, fruit_area, vegetable_area)%>%
  filter(StatCan_name %in% all_crop_list,
         GEO %in% c("Alberta", "British Columbia", "Saskatchewan", "Manitoba", "Ontario", "Quebec", "Prince Edward Island", "Nova Scotia", "Newfoundland and Labrador", "New Brunswick"))%>%
  filter(area_ha > 100)

## get crop production in kg, average over 3 years, and bind together ##
field_crop_prod <- field_crop_survey %>% 
  filter(`Harvest disposition` == "Production (metric tonnes)")%>%
  mutate(yield_kg = VALUE*1000)%>%
  replace_na(list(yield_kg = 0))%>%
  select(StatCan_name, GEO, yield_kg)%>%
  group_by(GEO, StatCan_name)%>%
  summarise(yield_kg = mean(yield_kg))

potato_prod <- potato_survey%>%
  filter(`Area, production and farm value of potatoes` == "Production, potatoes")%>%
  #convert hundredweight * 1000 to kg
  mutate(yield_kg = VALUE*50.8*1000)%>%
  replace_na(list(yield_kg = 0))%>%
  select(StatCan_name, GEO, yield_kg)%>%
  group_by(GEO, StatCan_name)%>%
  summarise(yield_kg = mean(yield_kg))

fruit_prod <- fruits_survey%>%
  filter(Estimates == "Marketed production", UOM == "Metric tonnes")%>%
  mutate(yield_kg = VALUE*1000)%>%
  replace_na(list(yield_kg = 0))%>%
  select(StatCan_name, GEO, yield_kg)%>%
  group_by(GEO, StatCan_name)%>%
  summarise(yield_kg = mean(yield_kg))

vegetable_prod <- vegetables_survey%>%
  filter(Estimates == "Marketed production (metric tonnes)")%>%
  mutate(yield_kg = VALUE*1000)%>%
  replace_na(list(yield_kg = 0))%>%
  select(StatCan_name, GEO, yield_kg)%>%
  group_by(GEO, StatCan_name)%>%
  summarise(yield_kg = mean(yield_kg))

crop_prod <- bind_rows(field_crop_prod, potato_prod, fruit_prod, vegetable_prod)%>%
  filter(StatCan_name %in% all_crop_list,
         GEO %in% c("Alberta", "British Columbia", "Saskatchewan", "Manitoba", "Ontario", "Quebec", "Prince Edward Island", "Nova Scotia", "Newfoundland and Labrador", "New Brunswick"))%>%
  filter(yield_kg > 1000)
```

```{r N_fertilizer, echo=FALSE, message = FALSE}
#Fertilizer Sales N
#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100039-eng.zip", "Data/Food/Fertilizer/32100039-eng.zip")
N_fert_sales <- read_csv("Data/Food/Fertilizer/32100039.csv")%>%
  as_tibble()%>%
  separate(`REF_DATE`, sep="/", into=c("REF_DATE", "month"))%>%
  filter(`Fertilizer nutrient content` == "Nitrogen",
         Period == "July to June",
         #get whole year, intead of just growing season
         REF_DATE %in% (years))%>%
  #BC missing a value for 2018, used average of previous two years
  replace_na(list(VALUE = 24.5))%>%
  group_by(GEO, `Fertilizer nutrient content`, UOM, SCALAR_FACTOR)%>%
  summarise(quantity = mean(VALUE))%>%
  mutate(sales_N_kg = quantity*1000000)

#Recommended N Application Rates
#from @yangDevelopment2007
#added wheat as average of spring and winter (almost the same)
N_recommended_rates <- read_excel("Data/Food/Fertilizer/recommended_fertilizer.xlsx")%>%
  mutate("Canada" = (rowSums(.[2:7])/7))%>%
  gather(GEO, Rate_kg_ha, `British Columbia`:`Canada`)

#Fertilizer N Application adjusted
#actual N applied on each crop estimated by adjusting the recommended rate for each crop type by the ratio of total N sold provincially (kg) to the total N if recommended rates were used @yangDevelopment2007
#Note for fertilizer rates and sales data, PEI, NB NFLD and NS were grouped together as the Atlantic Provinces, so the application rate for these provinces was adjusted by this region 
#Tame hay fertilizer is a mix of alfalfa and tame hay/other. weighted by two thirds area
N_rec_fert_crop <- mutate(crop_area, key_rec_fert = case_when(StatCan_name %in% vegetable_list ~ "Vegetables",
                                                              StatCan_name %in% c("carrots", "dry onions", "parsnips", "rutabagas and turnips", "beets") ~ "Vegetables",
                                                          StatCan_name %in% c("blueberries", "raspberries", "strawberries", "cranberries") ~ "Berries",
                                                          StatCan_name %in% c("apples", "peaches", "pears", "plums and prune plums", "nectarines", "sour cherries", "sweet cherries") ~ "Tree fruits",
                                                          StatCan_name %in% c("Barley", "Canary seed", "Rye, all", "Triticale") ~ "Other field",
                                                          StatCan_name %in% c("Beans, all dry (white and coloured)", "Chick peas", "Faba beans", "Lentils", "Peas, dry") ~ "Pulses",
                                                          StatCan_name == "Canola (rapeseed)" ~ "Canola",
                                                          StatCan_name == "Flaxseed" ~ "Flax seed",
                                                          StatCan_name == "Sunflower seed" ~ "Sunflower",
                                                          StatCan_name == "Sugar beets" ~ "Sugar beet",
                                                          StatCan_name == "Wheat, all" ~ "Wheat",
                                                          StatCan_name == "grapes" ~ "Grapes",
                                                          StatCan_name == "Tame hay" ~ "Tame hay (mix)",
                                                          TRUE ~ StatCan_name))%>%
  #StatCan crop names were matched to crop categories for recommended fertilization rates
  left_join(N_recommended_rates, by  = c("key_rec_fert" = "Crop", "GEO"="GEO"))%>%
  #total *recommended* fertilizer use for a given crop in a province
  mutate(N_rec_crop_kg = area_ha*Rate_kg_ha)%>%
  mutate(key_prov_fert = case_when(GEO %in% c("Prince Edward Island", "New Brunswick", "Nova Scotia", "Newfoundland and Labrador") ~ "Atlantic provinces",
                                   TRUE ~ GEO))

#total *recommended* fertilizer use by province
N_rec_fert_prov <- mutate(N_rec_fert_crop, key_prov_fert = case_when(GEO %in% c("Prince Edward Island", "New Brunswick", "Nova Scotia", "Newfoundland and Labrador") ~ "Atlantic provinces",
                                                                     TRUE ~ GEO))%>%
  group_by(key_prov_fert)%>%
  summarize(Total_N_rec_prov = sum(N_rec_crop_kg))

N_adjusted_fert <- left_join(N_rec_fert_crop, N_rec_fert_prov)%>%
  left_join(N_fert_sales, by = c("key_prov_fert" = "GEO"))%>%
  #adjusted by sale/recommended ratio
  mutate(N_applied_crop_kg = (N_rec_crop_kg * sales_N_kg / Total_N_rec_prov))%>%
  #calculated the difference between what the total N value should be if recommended rates were being used, and sales-based values
  mutate(Diff_sales_rec = N_applied_crop_kg - N_rec_crop_kg)
```

```{r N_BNF, echo=FALSE, message = FALSE}
#BNF rates, HI and residues from @karimi2020
HI_Nconc_BNF <- read_excel("Data/Food/Production/Crop/HI_Nconc_BNF.xlsx")%>% #Karimi et al 2020, table A1
  as_tibble()

#BNF fixation
#took weighted average for tame hay other/tame hay alfalfa based on Karimi area of crops
N_BNF <- mutate(crop_prod, key = case_when(StatCan_name %in% vegetable_list ~ "Vegetables",
                                                              StatCan_name %in% c("carrots", "dry onions", "parsnips", "rutabagas and turnips", "beets") ~ "Vegetables",
                                                          StatCan_name %in% c("blueberries", "raspberries", "strawberries", "cranberries", "saskatoon berries", "grapes") ~ "Berries and grapes",
                                                          StatCan_name %in% c("apples", "peaches", "pears", "plums and prune plums", "nectarines", "sour cherries", "sweet cherries") ~ "Tree fruit",
                                                          TRUE ~ StatCan_name))%>%
  left_join(HI_Nconc_BNF, by = c("key" = "Crop"))%>%
  mutate(yield_DM_kg = yield_kg * ((1-(`H20 content (%w/w)`/100))),
         yield_N_kg = yield_DM_kg * (`N conc res (%DM)`/100),
         residue_DM_kg = case_when(key %in% c("Berries and grapes", "Tree fruit") ~ ((yield_DM_kg / HI) - yield_DM_kg) * 0.1, #takes in to account 10 yr lifespan of trees/shrubs
                                StatCan_name == "Tame hay" ~ ((yield_DM_kg / HI) - yield_DM_kg)  * 0.2, #takes in to account 5 yr lifespan of hay
                                TRUE ~ ((yield_DM_kg / HI) - yield_DM_kg)),
         residue_N_kg = residue_DM_kg * `N conc res (%DM)`/ 100,
         root_DM_kg = `Below Ground Residue (% of DM harvest)`/ 100  * yield_DM_kg,
         root_N_kg = root_DM_kg * (`N conc root (%DM)`/100),
         N_BNF_kg = (yield_N_kg + residue_N_kg + root_N_kg) * (`%BNFA`/100))%>%
  replace_na(list(N_BNF_kg=0))
```

```{r N_field_loss, echo=FALSE, message = FALSE}

#Yield N concentrations and allocations of products and aboveground residues taken from @karimiupdated2020
residue_allocation <- read_excel("Data/Food/Production/Crop/residue_allocation.xlsx")

leaching <- read_excel("Data/Food/Leaching.xlsx", range = "A2:V13")%>% #DeYong2009 Table
  select(`...1`, `mean...22`)%>%
  rename("GEO" = `...1`, "leaching loss %N" = `mean...22`)

N_field_loss <- left_join(N_adjusted_fert, N_BNF, by = c("GEO"="GEO", "StatCan_name"="StatCan_name"))%>%
  select(-c(key_prov_fert, "Fertilizer nutrient content", UOM, SCALAR_FACTOR, quantity))%>%
  left_join(residue_allocation, by = c("key" = "Crop"))%>%
  left_join(leaching)%>%
  mutate(residue_to_soil_N_kg = residue_N_kg * `Residue: Soil %`, #residue recycling assume adds to organic N in soil? #assume root absorbed same as Karimi
         denitrification_N20_kg = (residue_to_soil_N_kg + root_N_kg) * 0.05,
         leaching = (residue_to_soil_N_kg + root_N_kg) * `leaching loss %N`, 
         N_loss_field_kg = N_applied_crop_kg + N_BNF_kg - yield_N_kg + denitrification_N20_kg + leaching,
         N_diff_kg = N_applied_crop_kg + N_BNF_kg - yield_N_kg)%>%
  #to get rid of oddness in surveys, e.g. some crops in some provinces have an area but no harvest or vice versa
  filter(area_ha > 0,
         yield_kg > 0)%>%
  select(-c(4, 6:8, key, "Source.x", "Source.y"))
#there area couple negative values. Soil N mining? 
```

```{r N_crop_processing_loss, echo=FALSE, message = FALSE}
#USDA https://www.ers.usda.gov/data-products/food-availability-per-capita-data-system/ 
food_processing_waste <- read_excel("Data/Food/Food_waste/food_loss_USDA.xlsx", range = "A1:D11")
  
#Processing loss
N_crop_process <- mutate(N_field_loss, key_process = case_when(StatCan_name %in% cereals_list ~ "Grains",
                                                 StatCan_name %in% oilseed_list ~ "Fats",
                                                 StatCan_name %in% legume_list ~ "Legumes",
                                                 StatCan_name %in% root_list ~ "Vegetables",
                                                 StatCan_name %in% fruit_list ~ "Fruits",
                                                 StatCan_name %in% vegetable_list ~ "Vegetables",
                                                 TRUE ~ StatCan_name))%>%
  left_join(food_processing_waste, by = c("key_process" = "Food Item"))%>%
  mutate(consumed_kg = yield_kg * `Total loss all levels`/100,
         consumed_N_kg = consumed_kg * (1-(`H20 content (%w/w)`/100)) * (`N conc prod (%DM)`/100),
         N_loss_processing_waste_kg = yield_N_kg - consumed_N_kg)%>%
  mutate(`Food group` = case_when(StatCan_name %in% cereals_list ~ "Grains",
                                                 StatCan_name %in% oilseed_list ~ "Oilseeds",
                                                 StatCan_name %in% legume_list ~ "Legumes",
                                                 StatCan_name %in% root_list ~ "Roots",
                                                 StatCan_name %in% fruit_list ~ "Fruits",
                                                 StatCan_name %in% vegetable_list ~ "Vegetables"))
```

```{r VNF_food_crop, echo=FALSE, message = FALSE}
VNF_crop_group_prov <- N_crop_process%>%
  mutate(Total_N_loss_kg = N_loss_field_kg + N_loss_processing_waste_kg,
         `VNF kgN/kg` = (Total_N_loss_kg / consumed_kg),
         `VNF kgN/kgN` = (Total_N_loss_kg / consumed_N_kg))%>%
  group_by(GEO, `Food group`)%>%
  summarise(`VNF kgN/kg` = weighted.mean(`VNF kgN/kg`, yield_kg), 
            `VNF kgN/kgN`= weighted.mean(`VNF kgN/kgN`, yield_kg))%>%
  drop_na()

#Canadian VNFs by yield weighted average (i.e. avg VNFs are most similar to whichever province grows the most of that food)
VNF_crop_group_CAN <- N_crop_process%>%
  mutate(Total_N_loss_kg = N_loss_field_kg + N_loss_processing_waste_kg,
         `VNF kgN/kg` = (Total_N_loss_kg / consumed_kg),
         `VNF kgN/kgN` = (Total_N_loss_kg / consumed_N_kg))%>%
  group_by(`Food group`)%>%
  summarise(`VNF kgN/kg` = weighted.mean(`VNF kgN/kg`, yield_kg))%>%
  mutate(GEO = "Canada")%>%
  drop_na()%>%
  mutate(`N footprint sector` = "VN from crops")
#write_csv(VNF_food_group_CAN, file.path("Results_Images/VNF_food_group_CAN.csv"))

VNF_crop_group <- bind_rows(VNF_crop_group_prov, VNF_crop_group_CAN)%>%
  mutate(`N footprint sector` = "VN from crops",
         GEO = case_when(GEO == "Prince Edward Island" ~ "P.E.I",
                         TRUE ~ GEO))

VNF_crop_group$GEO <- factor(VNF_crop_group$GEO,levels = c("Canada", "British Columbia", "Alberta", "Saskatchewan", "Manitoba", "Ontario", "Quebec", "New Brunswick", "Nova Scotia", "P.E.I"))

#write_csv(VNF_crop_group, file.path("Results_Images/VNF_crop_group.csv"))
```

*Notes on VNF results/cross check with Leach 2020
Veg and root VNFs are similar. Grains and fruit about 3 times as high. This seems plausible due to climate, also because of different fruit choices. e.g. apples are about twice, blueberries (a significant crop), are much higher. Legumes are significantly higher, this is because I include more than soybeans (which alone are comparable to Leach). Other legumes have fertilizer recommendations as well, which will increase the VNF dramatically. Also using actual sales, which are almost all higher than recommended rate

```{r VNF_feed, echo=FALSE, message = FALSE}
VNF_feed_prov <- N_crop_process%>%
  filter(StatCan_name %in% feed_list)%>%
  mutate(`VNF kgN/kg` = (N_loss_field_kg / yield_kg),
         `VNF kgN/kgN` = (N_loss_field_kg / yield_N_kg))
#write_csv(VNF_feed, file.path("Data/Results/VNF_feed.csv"))

#Canadian VNFs by yield weighted average (i.e. avg VNFs are most similar to whichever province grows the most of that food)
VNF_feed_CAN <- VNF_feed_prov%>%
  group_by(`StatCan_name`)%>%
  summarise(`VNF kgN/kg` = weighted.mean(`VNF kgN/kg`, yield_kg),
            `VNF kgN/kgN` = weighted.mean(`VNF kgN/kgN`, yield_kg))%>%
  drop_na()%>%
  filter(StatCan_name!= "Sugar beets")%>%
  rename(`Crop type` = StatCan_name)

## Graphing ##
ggplot(VNF_feed_CAN, aes(y = `VNF kgN/kg`*1000, x = `Crop type`, fill = `Crop type`)) +
  geom_bar(position="stack", stat="identity") +
  labs(caption = "Virtual nitrogen factors (g N / kg) for feed crops") +
  scale_fill_brewer(palette="Paired")+
  theme_classic()+
  theme(axis.title.y = element_blank(), 
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_blank(),
        plot.caption = element_text(hjust = 0))

#ggsave("Results_Images/VNF_feed_avg.pdf")
```

```{r animal_pop_data, echo=FALSE, message = FALSE}
#note on chicken numbers: there's no info # of broiler chickens. Have # of layers, and total number slaughtered. To estimate standing broiler population we have taken the number of total chickens slaughtered in a year and divided by 6.2 (Huffman), which assumes the average age to maturity ~60 days to estimate the number of broilers (matches closely with 114 million number from SPCA). 

#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100121-eng.zip")
layer_prod <- read_csv("Data/Food/Production/Animal/32100119.csv")%>%
  as_tibble()%>%
  filter(`Production and disposition` %in% c("Disposition of eggs in shell sold for consumption [116111111]", "Disposition of eggs in shell, leakers and rejects [116111311]", "Average number of layers"))

layer_pop <- layer_prod%>%
  mutate(StatCan_name = case_when(`Production and disposition` == "Average number of layers" ~ "Layers"))%>%
  filter(REF_DATE %in% years,
         StatCan_name == "Layers")%>%
  replace_na(list(VALUE=0))%>%
  group_by(GEO, StatCan_name, UOM, SCALAR_FACTOR)%>%
  summarise(VALUE = mean(VALUE))

#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100117-eng.zip")
poultry_prod <- read_csv("Data/Food/Production/Animal/32100117.csv")%>%
  as_tibble()%>%
  filter(`Commodity`== "Chicken (including stewing hen)", `Production and disposition`=="Production, total", Estimates == "Birds")%>%
  mutate("StatCan_name" = "Broiler")%>%
  filter(REF_DATE %in% years)%>%
  replace_na(list(VALUE=0))%>%
  group_by(GEO, StatCan_name, UOM, SCALAR_FACTOR)%>%
  summarise(VALUE = mean(VALUE))

#adjusted Atlantic provinces by number of broiler farms 2016 census
broiler_pop <- poultry_prod%>%
  mutate(VALUE = case_when(GEO == "New Brunswick" ~ 53134 * 12/117 /6.2,
                           GEO == "Prince Edward Island" ~ 53134 * 12/117 /6.2, 
                           GEO == "Nova Scotia" ~ 53134 * 87/117 / 6.2 ,
                           GEO == "Newfoundland and Labrador" ~ 53134  * 6/117 /6.2,
                           TRUE ~ VALUE/6.2))%>%
  select(GEO, StatCan_name, UOM, SCALAR_FACTOR, VALUE)

#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100130-eng.zip")
beef_pop <- read_csv("Data/Food/Production/Animal/32100130.csv")%>%
  as_tibble()%>%
  rename("StatCan_name" = "Livestock")%>%
  filter(`Survey date` == "At January 1",
         `Farm type` %in% c("On dairy operations", "On beef operations"),
         StatCan_name %in% c("Dairy cows", "Beef cows", "Total beef heifers", "Calves, under 1 year", "Bulls, 1 year and over", "Heifers for dairy replacement", "Steers, 1 year and over"),
         REF_DATE %in% years)%>%
  group_by(REF_DATE, GEO, StatCan_name, UOM, SCALAR_FACTOR)%>% #sum animals on beef and dairy operations
  summarise(VALUE = sum(VALUE))%>%
  group_by(GEO, StatCan_name, UOM, SCALAR_FACTOR)%>%
  summarise(VALUE = mean(VALUE)) #average pop over 3 years

#download.file("https://www150.statcan.gc.ca/n1/tbl/csv/32100160-eng.zip")
pork_pop <- read_csv("Data/Food/Production/Animal/32100160.csv")%>%
  as_tibble()%>% 
  rename("StatCan_name" = "Livestock")%>%
  filter(`Survey date` == "At January 1", StatCan_name %in% c( "Over 81 kilograms", "54 to 80 kilograms", "23 to 53 kilograms", "Boars, 6 months and over", "Sows and gilts, 6 months and over"))%>% #didn't include under 23kg because piglets/grower feed hard to measure (also not sure how much of the population is slaughtered) 
  group_by(GEO, StatCan_name, UOM, SCALAR_FACTOR)%>%
  summarise(VALUE = mean(VALUE))%>%
  replace_na(list(VALUE = 0))

animal_pop <- bind_rows(beef_pop, pork_pop, broiler_pop, layer_pop)

```

```{r VN and N per kg feed, echo=FALSE, message = FALSE}
VNF_feed <- VNF_feed_CAN%>%
  select(`Crop type`, "VNF kgN/kg")%>%
  pivot_wider(names_from =`Crop type`, values_from = "VNF kgN/kg")%>%
  mutate(feed_VN = "feed VN kgN/kg")

N_cont_feed <- HI_Nconc_BNF%>%   #from @Karimi2020
  select(Crop, `N conc prod (%DM)`)%>%
  pivot_wider(names_from = Crop, values_from = `N conc prod (%DM)`)%>%
  mutate(feed_N = "feed N conc DMI")
  
VN_N_feed <- read_excel("Data/Food/Production/Animal/Feed_ratios.xlsx")%>%  #feed ratios from #Sheppard 2015, Table 3, calf values are avg
  as_tibble()%>%
  pivot_longer(cols=3:10, names_to = "Region", values_to = "Fraction")%>%
  mutate(feed_VN = "feed VN kgN/kg", feed_N = "feed N conc DMI")%>%
  left_join(VNF_feed)%>%
  #adjust StatCan feedcrops to match Sheppards categories (not quite the same)
  mutate(feed_group_VNF_kgN_kg = case_when(Region == "%Grain east" ~ (`Barley` + `Corn for silage` + `Soybeans`)/3,
                                    Region == "%Grain west" ~ `Barley`,
                                    Region == "%Whole corn east" ~ `Corn for silage`,
                                    Region == "%Whole corn west" ~ `Corn for silage`,
                                    Region == "%Straw/Hay east" ~ (`Wheat, all` + `Barley`)/2,
                                    Region == "%Straw/Hay west" ~ (`Wheat, all` + `Barley`)/2,
                                    Region == "%Forage east" ~ `Tame hay`/2, #assume natural pasture has no VNF
                                    Region == "%Forage west" ~ `Tame hay`/2,
                                    TRUE ~ 0))%>%
  select(1:4, 6, 12)%>%
  left_join(N_cont_feed)%>%
  mutate(feed_group_N_conc_DMI = case_when(Region == "%Grain east" ~ (`Barley` + `Corn for silage` + `Soybeans`)/3,
                                   Region == "%Grain west" ~ `Barley`,
                                   Region == "%Whole corn east" ~ `Corn for silage`,
                                   Region == "%Whole corn west" ~ `Corn for silage`,
                                   Region == "%Straw/Hay east" ~ (`Wheat, all` + `Wheat, all` + `Barley`)/3,
                                   Region == "%Straw/Hay west" ~ (`Wheat, all` + `Barley`)/2,
                                   Region == "%Forage east" ~ (`Tame hay` + `Pasture (nat)`)/2,
                                   Region == "%Forage west" ~ (`Tame hay` + `Pasture (nat)`)/2,
                                   TRUE ~ `Pasture (nat)`))%>%
  select(1:4, 6, 39)
```

```{r N_feed, echo=FALSE, message = FALSE}
N_feed <- animal_pop%>%
  #match StatCanName to Sheppard's feed groups
  mutate(key_feed = case_when(StatCan_name == "54 to 80 kilograms" ~ "Grower",
                              StatCan_name == "Over 81 kilograms" ~ "Grower",
                              StatCan_name == "23 to 53 kilograms" ~ "Grower",
                              StatCan_name == "Beef cows" ~ "Beef cow",
                              StatCan_name == "Boars, 6 months and over"~ "Boar",
                              StatCan_name == "Bulls, 1 year and over" ~ "Beef bull",
                              StatCan_name == "Calves, under 1 year"~ "Calves",
                              StatCan_name == "Dairy cows"  ~ "Dairy cow",
                              StatCan_name == "Heifers for dairy replacement"~ "Dairy heifer",
                              StatCan_name == "Sows and gilts, 6 months and over"~ "Sow and gilts",
                              StatCan_name == "Steers, 1 year and over" ~ "Beef steer",
                              StatCan_name == "Total beef heifers"~ "Beef heifer",
                              StatCan_name == "Layers"~ "Layer",
                              StatCan_name == "Broiler"~ "Broiler",
                              TRUE ~ StatCan_name))%>%
  left_join(VN_N_feed, by = c("key_feed"="Animal"))%>%
  mutate(VN_feed_kg = case_when((GEO %in% c('British Columbia', 'Alberta', 'Saskatchewan', 'Manitoba')) & (Region %in% c("%Grain west", "%Whole corn west", "%Straw/Hay west", "%Forage west")) ~ VALUE * 1000 * `Feed DMI kg/animal/year` * Fraction * `feed_group_VNF_kgN_kg`,
                                (GEO %in% c("Ontario", "Quebec", "Nova Scotia", "Prince Edward Island", "New Brunswick", "Newfoundland and Labrador")) & (Region %in% c("%Grain east", "%Whole corn east", "%Straw/Hay east", "%Forage east")) ~ VALUE * 1000 * `Feed DMI kg/animal/year` * Fraction * `feed_group_VNF_kgN_kg`))%>%
  mutate(N_feed_kg = case_when((GEO %in% c('British Columbia', 'Alberta', 'Saskatchewan', 'Manitoba')) & (Region %in% c("%Grain west", "%Whole corn west", "%Straw/Hay west", "%Forage west")) ~ VALUE * 1000 * `Feed DMI kg/animal/year` * Fraction * feed_group_N_conc_DMI / 100,
                                (GEO %in% c("Ontario", "Quebec", "Nova Scotia", "Prince Edward Island", "New Brunswick", "Newfoundland and Labrador")) & (Region %in% c("%Grain east", "%Whole corn east", "%Straw/Hay east", "%Forage east")) ~ VALUE * 1000 * `Feed DMI kg/animal/year` * Fraction * feed_group_N_conc_DMI / 100))%>%
  replace_na(list(VN_feed_kg=0, N_feed_kg=0))%>%
  group_by(GEO, StatCan_name, VALUE, UOM, SCALAR_FACTOR, key_feed)%>%
  summarise(VN_feed_kg = sum(VN_feed_kg),
            N_feed_kg = sum(N_feed_kg))%>%
  filter(GEO %in% c('British Columbia', 'Alberta', 'Saskatchewan', 'Manitoba', "Ontario", "Quebec", "Nova Scotia", "Prince Edward Island", "New Brunswick", "Newfoundland and Labrador"))

```

```{r N_manure_production, echo=FALSE, message = FALSE}
slaughter_processing <- read_excel("Data/Food/Production/Animal/animal_processing_conversion.xlsx")%>% #Sheppard2015 Table 4 & 5 
  select(`Animal`,`Fraction Population slaughtered`, `Weight at slaughter (kg/animal)`) #using karimi and USDA values for other columns
  
animal_N <- read_excel("Data/Food/Production/Animal/animal_N.xlsx") #Karimi 2020, Table A2

egg_prod <- layer_prod%>%
  filter(`Production and disposition` %in% c("Disposition of eggs in shell sold for consumption [116111111]",
                                             "Disposition of eggs in shell, leakers and rejects [116111311]"),
         REF_DATE %in% years)%>%
  group_by(GEO, `Production and disposition`, UOM, SCALAR_FACTOR)%>%
  summarise(VALUE = mean(VALUE))%>%
  mutate(egg_kg = VALUE * 12 * 1000 * 0.056)%>% #avg large egg weight 56g
  select(GEO, `Production and disposition`, egg_kg)%>%
  pivot_wider(names_from = `Production and disposition`, values_from = egg_kg)%>%
  mutate(Animal="Layers")%>%
  rename("eggs_kg" = `Disposition of eggs in shell sold for consumption [116111111]`, "leakers_kg" = `Disposition of eggs in shell, leakers and rejects [116111311]`)

# included Milk sold for industrial purposes (for cheese yogurt, icecream etc)?
milk <- read_csv("Data/Food/Production/Animal/32100113.csv")%>%
  as_tibble()%>%
  separate(`REF_DATE`, sep="-", into=c("year", "month"))
milk$month = as.double(milk$month)
milk$year = as.double(milk$year)
milk_prod <- milk%>%
  filter(month == 1,
         year %in% years,
         `Dairy distribution` == "Milk sold off farms, total")%>%
  group_by(GEO, `Dairy distribution`, UOM, SCALAR_FACTOR)%>%
  summarise(VALUE = mean(VALUE))%>%
  mutate(Animal = "Dairy cows",
         milk_kg = VALUE * 1000)%>%
  select(GEO, Animal, milk_kg)

N_manure_prod <- N_feed%>%
  #match StatCanName to Karimi animal N
  mutate(key_animalN = case_when(StatCan_name == "Over 81 kilograms" ~ "Hog",
                                StatCan_name == "54 to 80 kilograms" ~ "Hog",
                                StatCan_name == "23 to 53 kilograms" ~ "Hog",
                              StatCan_name == "Beef cows" ~ "Cattle",
                              StatCan_name == "Boars, 6 months and over"~ "Hog",
                              StatCan_name == "Bulls, 1 year and over" ~ "Cattle",
                              StatCan_name == "Calves, under 1 year"~ "Calves",
                              StatCan_name == "Dairy cows"  ~ "Cattle",
                              StatCan_name == "Heifers for dairy replacement"~ "Cattle",
                              StatCan_name == "Sows and gilts, 6 months and over"~ "Hog",
                              StatCan_name == "Steers, 1 year and over" ~ "Cattle",
                              StatCan_name == "Total beef heifers"~ "Cattle",
                              StatCan_name == "Layers"~ "Chicken",
                              StatCan_name == "Broiler"~ "Chicken"),
         key_product = case_when(StatCan_name == "Over 81 kilograms"  ~ "Pork",
                                    StatCan_name == "54 to 80 kilograms" ~ "Pork",
                                StatCan_name == "23 to 53 kilograms" ~ "Pork",
                               StatCan_name == "Beef cows" ~ "Beef",
                               StatCan_name == "Boars, 6 months and over" ~ "Pork",
                               StatCan_name == "Broiler" ~ "Chicken",
                               StatCan_name == "Bulls, 1 year and over"  ~ "Beef",
                               StatCan_name == "Calves, under 1 year" ~ "Beef",
                               StatCan_name == "Heifers for dairy replacement" ~ "Milk",
                               StatCan_name == "Dairy cows" ~ "Milk",
                               StatCan_name == "Layers" ~ "Eggs",
                               StatCan_name == "Sows and gilts, 6 months and over" ~ "Pork",
                               StatCan_name == "Steers, 1 year and over" ~ "Beef",
                               StatCan_name == "Total beef heifers" ~ "Beef",
                               TRUE ~ StatCan_name))%>%
  left_join(animal_N, by = c("key_animalN"="Livestock Type"))%>%
  left_join(milk_prod, by = c("StatCan_name" = "Animal", "GEO"="GEO"))%>%
  left_join(egg_prod, by = c("StatCan_name" = "Animal", "GEO"="GEO"))%>%
  left_join(slaughter_processing, by = c("key_feed" = "Animal"))%>%
  mutate(animals_slaughtered = VALUE * 1000 * `Fraction Population slaughtered`,
         N_animal_content_kg = animals_slaughtered * `Weight at slaughter (kg/animal)` * `% N live weight`,
         yield_kg = case_when(key_product %in% c("Pork", "Beef", "Chicken") ~ animals_slaughtered * `Weight at slaughter (kg/animal)` * `% dressed/live`,
                              key_product == "Milk" ~ milk_kg,
                              key_product == "Eggs" ~ `eggs_kg` + `leakers_kg`) ,
         yield_N_kg = case_when(key_product %in% c("Pork", "Beef", "Chicken") ~ yield_kg * `% N carcass`,
                                key_product == "Milk" ~ yield_kg * 0.0005643,   # %N from Karimi
                                key_product == "Eggs" ~ yield_kg * 0.0199),   #%N from Karimi
         slaughter_loss_N_kg = case_when(key_product %in% c("Pork", "Beef", "Chicken") ~ N_animal_content_kg - yield_N_kg,
                                         TRUE ~ 0))%>%   
  replace_na(list(yield_N_kg=0)) %>% #assigns 0 milk production to dairy heifers, as it has been assigned to dairy cows. Manure #'s grouped later 
  mutate(N_manure_prod_kg = case_when(key_product %in% c("Pork", "Beef", "Chicken") ~ N_feed_kg - N_animal_content_kg,
                              key_product %in% c("Milk", "Eggs") ~ N_feed_kg - yield_N_kg))%>%
  replace_na(list(N_manure_prod_kg = 0, VALUE = 0, yield_kg=0))%>%
  filter((GEO %in% c("Quebec", "Ontario", "Prince Edward Island", "New Brunsiwck", "Manitoba", "Saskatchewan", "Alberta", "Nova Scotia", "Newfoundland and Labrador", "British Columbia")))

  #mutate(`manure/head`= N_manure_prod_kg/VALUE/1000)%>%
  #group_by(key_product)%>%
  #summarise(`manure/head` = weighted.mean(`manure/head`, VALUE))

#*manure sanity check* compare to Huffman(mine): manure production per head broiler 0.4 (0.21), layer 0.6 (0.75), dairy cow 122 (111 (note heifers are less)), calves 25 (25), beef cattle 78 (54, cows and bulls much higher), hogs 9.9 (14) Ontario is closer to this

#compared population slaughtered to # Canadian animals slaughtered per year: cattle (~6%) hogs (~1%) chicken (~4%)

```

```{r, N manure recycling and loss, echo=FALSE, message = FALSE}
manure_pasture <- read_excel("Data/Food/Production/Animal/manure_pasture.xlsx")%>% #Huffman 2008, Table 2
  as_tibble()%>%
  pivot_longer(`British Columbia`:`Newfoundland and Labrador`, names_to = "Province", values_to = "% on pasture")%>%
  select(!(`Kg N / head / yr`))

storage_loss <- read_excel("Data/Food/Production/Animal/manure_storage.xlsx")%>%  #Huffman 2008, Table 3 
  as_tibble()%>%
  pivot_longer(`Poultry`:`Others`, names_to = "Animal", values_to = "N% after storage")

N_manure_loss <- N_manure_prod%>%
  mutate(key_pasture = case_when(StatCan_name == "Over 81 kilograms" ~ "Hogs",
                                 StatCan_name == "54 to 80 kilograms" ~ "Hogs",
                                StatCan_name == "23 to 53 kilograms" ~ "Hogs",
                              StatCan_name == "Beef cows" ~ "Beef cattle",
                              StatCan_name == "Boars, 6 months and over"~ "Boars",
                              StatCan_name == "Bulls, 1 year and over" ~ "Bulls",
                              StatCan_name == "Calves, under 1 year"~ "Calves",
                              StatCan_name == "Dairy cows"  ~ "Dairy cows",
                              StatCan_name == "Heifers for dairy replacement"~ "Heifers",
                              StatCan_name == "Sows and gilts, 6 months and over"~ "Sows",
                              StatCan_name == "Steers, 1 year and over" ~ "Steers",
                              StatCan_name == "Total beef heifers"~ "Heifers",
                              StatCan_name == "Layers"~ "Laying hens",
                              StatCan_name == "Broiler" ~ "Broilers",
                              TRUE ~ StatCan_name),
         key_storage = case_when(StatCan_name == "Over 81 kilograms" ~ "Pigs",
                                 StatCan_name == "54 to 80 kilograms" ~ "Pigs",
                                StatCan_name == "23 to 53 kilograms" ~ "Pigs",
                              StatCan_name == "Beef cows" ~ "Cattle",
                              StatCan_name == "Boars, 6 months and over"~ "Pigs",
                              StatCan_name == "Bulls, 1 year and over" ~ "Cattle",
                              StatCan_name == "Calves, under 1 year"~ "Cattle",
                              StatCan_name == "Dairy cows"  ~ "Cattle",
                              StatCan_name == "Heifers for dairy replacement"~ "Cattle",
                              StatCan_name == "Sows and gilts, 6 months and over"~ "Pigs",
                              StatCan_name == "Steers, 1 year and over" ~ "Cattle",
                              StatCan_name == "Total beef heifers"~ "Cattle",
                              StatCan_name == "Layers"~ "Poultry",
                              StatCan_name == "Broiler"~ "Poultry",
                         TRUE ~ StatCan_name))%>%
  left_join(manure_pasture, by = c("key_pasture" = "Animal", "GEO" = "Province"))%>%
  left_join(storage_loss, by = c("key_storage" = "Animal", "GEO" = "Province"))%>%
  left_join(leaching)%>%
  mutate(N_manure_to_soil_kg = ((N_manure_prod_kg*(`% on pasture`/100)) + (N_manure_prod_kg*(1-(`% on pasture`/100))*(`N% after storage`/100))),
         N_manure_loss_storage_kg = N_manure_prod_kg - N_manure_to_soil_kg,
         N_manure_leaching_kg = N_manure_to_soil_kg * `leaching loss %N`,
         N_manure_N20_kg = N_manure_to_soil_kg * 0.05,
         N_manure_N2_kg = N_manure_to_soil_kg * 0.05,
         N_manure_recycled_kg = N_manure_to_soil_kg - N_manure_leaching_kg - N_manure_N20_kg - N_manure_N2_kg)
```

recycling of animal products? (e.g. pet food?) meat N content? Karimi vs CNF vs lasaletta

```{r N_process_meat, echo=FALSE, message = FALSE}

# food availability StatsCan doesn't have retail/household losses for meat items so went with USDA values
# meat production sanity check: see manure production

N_animal_process <- N_manure_loss%>%
  left_join(food_processing_waste, by = c("key_product" = "Food Item"))%>%
  mutate(consumed_kg = yield_kg * (1-(`Total loss all levels`/100)),
         consumed_N_kg = case_when(key_product == "Pork" ~ consumed_kg * 0.0448, #CNF tenderloin
                                   key_product == "Beef" ~ consumed_kg * 0.049, #ground beef CNF 
                                   key_product == "Chicken" ~ consumed_kg * 0.034, #CNF ground chicken
                                key_product == "Milk" ~ consumed_kg * 0.01152, #from CNF pdf (milk 2%)
                                key_product == "Eggs" ~ consumed_kg * 0.0192), #from  CNF pdf (boiled egg)
         food_waste_N_kg = yield_N_kg - consumed_N_kg)%>%
  rename("Food group" = "key_product")

  #select(GEO, StatCan_name, "Food group", animals_slaughtered, `Weight at slaughter (kg/animal)`, yield_kg, yield_N_kg, VN_feed_kg, N_manure_loss_storage_kg, N_manure_leaching_kg, N_manure_N20_kg, consumed_kg, consumed_N_kg, food_waste_N_kg)
 # filter(`Food group` %in% c("Eggs", "Chicken"))

```

```{r VNF_animal, echo=FALSE, message = FALSE}
VNF_meat_prov <-  N_animal_process%>%
  group_by(GEO, `Food group`)%>%
  summarise(across(c(VN_feed_kg, N_manure_loss_storage_kg, N_manure_leaching_kg, N_manure_N20_kg, food_waste_N_kg, consumed_kg, slaughter_loss_N_kg, consumed_N_kg), sum))%>%
  mutate(`VNF kgN/kg` = (VN_feed_kg + N_manure_loss_storage_kg + N_manure_leaching_kg + N_manure_N20_kg + slaughter_loss_N_kg +  food_waste_N_kg) / consumed_kg,
         `VNF kgN/kgN` = (VN_feed_kg + N_manure_loss_storage_kg + N_manure_leaching_kg + N_manure_N20_kg + slaughter_loss_N_kg + food_waste_N_kg) / consumed_N_kg)%>%
  select(GEO, `Food group`, `VNF kgN/kg`)%>%
  drop_na(`VNF kgN/kg`)%>% #drops provinces with no VNF/i.e no meat production of that type
  mutate(`N footprint sector` = "VN from meat")

VNF_meat_CAN <- N_animal_process%>%
  group_by(GEO, `Food group`)%>%
  summarise(across(c(VALUE, VN_feed_kg, N_manure_loss_storage_kg, N_manure_leaching_kg, N_manure_N20_kg, slaughter_loss_N_kg, food_waste_N_kg, consumed_kg, consumed_N_kg), sum))%>%
  mutate(`VNF kgN/kg` = (VN_feed_kg + N_manure_loss_storage_kg + N_manure_leaching_kg + N_manure_N20_kg + food_waste_N_kg) / consumed_kg,
         `VNF kgN/kgN` = (VN_feed_kg + N_manure_loss_storage_kg + N_manure_leaching_kg + N_manure_N20_kg + food_waste_N_kg) / consumed_N_kg)%>%
  select(GEO, VALUE, `Food group`, `VNF kgN/kg`)%>%
  group_by(`Food group`)%>%
  summarise(`VNF kgN/kg` = weighted.mean(`VNF kgN/kg`, VALUE))%>%
  mutate(GEO = "Canada",
         `N footprint sector` = "VN from meat")

VNF_meat <- bind_rows(VNF_meat_prov, VNF_meat_CAN)%>%
  mutate(GEO = case_when(GEO == "Prince Edward Island" ~ "PEI",
                   GEO == "Newfoundland and Labrador" ~ "NFLD",
                   TRUE ~ GEO))
#note dairy VF typically significantly higher than milk

VNF_meat$GEO <- factor(VNF_meat$GEO,levels = c("Canada", "British Columbia", "Alberta", "Saskatchewan", "Manitoba", "Ontario", "Quebec", "New Brunswick", "Nova Scotia", "PEI", "NFLD"))

```

```{r food_consumption, echo=FALSE, message = FALSE}
#CCHS Data
#download

CCHS_food_names <- read_excel("Data/Food/Consumption/cchs-82M0024-E-2015-nu-nci_EDITED.xlsx")%>%
  separate(`BNS name`, sep = "- ", into=c("gram", "BNS_name"))%>%
  separate(`gram`, sep="# ", into=c("#", "BNS_code"))%>%
  separate(BNS_code, sep =":", into=c("BNS_code", "other"))%>% #removes some names, e.g. 1%, 2% for milks but is ok for coding
  select(!c(1,3))

food_consum_g <- read_csv("Data/Food/Consumption/cchs-82M0024-E-2015-nu-nci_F1.csv")%>%
  select(GEO_PRV, BNSD01A:BNSD53B)%>%
  pivot_longer(cols=(BNSD01A:BNSD53B), names_to = c("BNS_code"))%>%
  left_join(CCHS_food_names)%>%
  mutate(food_group = case_when(BNS_name %in% c("Whole Grain/Oats/High Fibre Breakfast Cereals", "Rice", "Corn", "Pasta", "White Breads", "Whole Wheat Breads", "Other Whole Grain Breads", "Breakfast Cereal (Other)", "Cereal/Grains/Flours", "Pancakes/Waffles", "Dry Mixes (Cakes/Muffins/Pancakes)") ~ "Grains",
                                BNS_name %in% c("Milk : Whole",  "Milk : 2%", "Milk : 1%", "Milk : Skim" ) ~ "Dairy", #milk
                                BNS_name %in% c("Cheese: 10% B.F. to 25% B.F.", "Cheese: More than 25% B.F.", "Cheese : Less than 10% B.F.") ~ "Other Dairy",
                                BNS_name %in% c("Egg" ) ~ "Eggs",
                                BNS_name %in% c("Regular Margarine", "Block Margarine", "Vegetable oils") ~ "Oilseeds",
                                BNS_name %in% c("Veal : Lean + Fat/Ground", "Beef : Ground", "Beef : Lean + Fat", "Veal : Lean Only", "Beef : Lean Only") ~ "Beef",
                                BNS_name %in% c("Sausage", "Ham : Cured ", "Bacon", "Pork : Fresh ") ~ "Pork",
                                BNS_name %in% c("Chicken : Meat + Skin", "Chicken : Meat Only" ) ~ "Chicken",
                                BNS_name %in% c("Onion/Green Onions/Leeks/Garlic", "Celery", "Tomatoes", "Peppers : Red/Green", "Cabbage / Kale", "Lettuce/Leafy Greens (Spinach/Mustard Greens)", "Other Veg. (Cucumber/Beet/Turnip)", "Broccoli", "Squashes", "Mushrooms", "Cauliflower") ~ "Vegetables",
                                BNS_name %in% c("Peas/Snow Peas", "Beans", "Foods made with Vegetable Proteins (Tofu)", "Legume")~ "Legumes",
                                BNS_name %in% c("Carrots", "Potato", "Fried/Roasted Potatoes", "Potato Chips") ~ "Roots",
                                BNS_name %in% c("Apple", "Pears", "Citrus Fruit (Oranges/Lemons/Grapefruits)", "Banana", "Grapes/Raisins", "Peaches/Nectarines", "Melons (Canteloup/Honeydew/Watermelon)", "Strawberries", "Other Fruits (Blueberrie/Date/Kiwi/Fruit Salad)", "Cherries", "Pineapple", "Plums/Prunes") ~ "Fruits"))%>%
  left_join(prov_code, by = c("GEO_PRV"="GEO_code"))%>%
  replace_na(list(consumed_protein_g = 0))#for food with no protein content

# have not included plant milks, # animal fats,  fish yogurts nuts sugars and candies soda, alcohol, fruit drinks coffee tea water lamb baby food spices and baking soda etc 
#cross referenced total protein intake (FSDDPRO) with my estimated sum of food protein +/ - ~ 7%


#Food Availability Stats
# download https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=3210005401&pickMembers%5B0%5D=1.1&pickMembers%5B1%5D=3.370&cubeTimeFrame.startYear=2015&cubeTimeFrame.endYear=2019&referencePeriods=20150101%2C20190101

food_availability <- read_csv("Data/Food/Consumption/32100054.csv")%>%
  filter(`Food categories` == "Food available adjusted for losses",
         REF_DATE %in% years)%>%
  group_by(`Commodity`)%>%
  summarise(STATSCAN_consumed_kg = mean(VALUE))%>%
  mutate(food_group = case_when(Commodity %in% c("Apple sauce", "Apples canned", "Apples fresh", "Apples frozen", "Apricots canned", "Apricots fresh", "Artichokes fresh", "Asparagus canned", "Asparagus fresh", "Avocados fresh", "Baked and canned beans", "Bananas fresh", "Blueberries canned", "Blueberries fresh", "Blueberries frozen", "Cherries fresh", "Cherries frozen", "Cranberries fresh", "Grapefruits fresh", "Grapes fresh", "Lemons fresh", "Limes fresh", "Mandarins fresh" , "Melons total fresh", "Nectarines fresh", "Oranges fresh", "Peaches canned", "Peaches fresh", "Pears canned", "Pears fresh", "Pineapples canned", "Pineapples fresh", "Plums total fresh", "Raspberries frozen", "Strawberries canned", "Strawberries fresh",  "Strawberries frozen", "Fruits not specified canned", "Fruits not specified fresh", "Fruits not specified frozen") ~ "Fruits",
                                Commodity %in% c("Broccoli fresh", "Broccoli frozen", "Brussels sprouts fresh", "Brussels sprouts frozen", "Cabbage fresh", "Cauliflower fresh", "Cauliflower frozen", "Celery fresh", "Chinese cabbage fresh", "Cucumbers fresh","Eggplants fresh", "Garlic fresh", "Lettuce fresh", "Mushrooms canned", "Mushrooms fresh", "Peppers fresh", "Pumpkins and squash fresh", "Spinach fresh", "Spinach frozen", "Tomatoes canned", "Tomatoes fresh", "Tomatoes, pulp, paste and puree", "Vegetables not specified canned",  "Vegetables not specified frozen" ) ~ "Vegetables",
                                Commodity %in% c("Beets canned", "Beets fresh", "Carrots canned", "Carrots fresh", "Carrots frozen", "Parsnips fresh", "Leeks fresh", "Onions and shallots fresh", "Potatoes white fresh and processed", "Rutabagas and turnips fresh") ~ "Roots",
                                Commodity %in% c("Corn canned", "Corn flour and meal", "Corn fresh", "Corn frozen", "Oatmeal and rolled oats", "Wheat flour", "Rye flour") ~ "Grains",
                                Commodity %in% c("Beans green and wax canned", "Beans green and wax fresh", "Beans green and wax frozen", "Peas canned", "Peas fresh", "Peas frozen") ~ "Legumes",
                                Commodity %in% c("Beef and veal total, boneless weight") ~ "Beef",
                                Commodity %in% c("Chicken and stewing hen total, boneless weight") ~ "Chicken",
                                Commodity %in% c("Pork, boneless weight") ~ "Pork",
                                Commodity %in% c("Eggs") ~ "Eggs",
                                Commodity %in% c("Other whole milk products", "Partly skimmed milk 1%", "Partly skimmed milk 2%", "Skim milk", "Standard milk 3.25%") ~ "Dairy",
                                Commodity %in% c("Margarine", "Salad oils") ~ "Oilseeds"))%>%
  group_by(food_group)%>%
  summarise(STATSCAN_consumed_kg = sum(STATSCAN_consumed_kg))%>%
  drop_na()
 #note have not included juices, various milk products, fish

#adjusting CCHS by national food availabilty data
food_consum_prov <- food_consum_g%>%
  mutate(consumed_protein = value * `% N`)%>%
  group_by(GEO, food_group)%>%
  summarise(`CCHS consumed kg/cap/year` = mean(value)*365/1000, `mean % N` = mean(`% N`))%>%
  drop_na()

food_consum_CAN <- food_consum_prov%>%
  group_by(food_group)%>%
  summarise(`CAN total consumed kg` = sum(`CCHS consumed kg/cap/year`))%>%
  drop_na()

food_consum <- left_join(food_consum_prov, food_consum_CAN)%>%
  left_join(food_availability)%>%
  mutate(`consumed kg/cap` = `CCHS consumed kg/cap/year` * STATSCAN_consumed_kg * 10 / `CAN total consumed kg`,
         `consumed N kg/cap` = `consumed kg/cap` * `mean % N`,
         GEO = case_when(GEO == "Newfoundland Labrador" ~ "Newfoundland and Labrador",
                   TRUE ~ GEO))%>%
  drop_na()%>%
  left_join(prov_pop)%>%
  mutate(`consumed N kg` = `consumed N kg/cap` * Population, `consumed kg` = `consumed kg/cap`*Population)

```

```{r Food consumption stats analysis, echo=FALSE, message = FALSE}
#ggqqplot(beef_cons_fix$value)

beef_cons <- food_consum_g%>%
  filter(food_group == "Beef", value > 0)
  group_by(GEO)%>%
  summarise(mean=mean(value), median = median(value))

pork_cons <- food_consum_g%>%
  filter(food_group == "Pork", value > 0)%>%
  group_by(GEO)%>%
  summarise(mean=mean(value), median = median(value))

chicken_cons <- food_consum_g%>%
  filter(food_group == "Chicken", value > 0)%>%
  group_by(GEO)%>%
  summarise(mean=mean(value), median = median(value))

dairy_cons <- food_consum_g%>%
  filter(food_group == "Milk", value > 0)%>%
  group_by(GEO)%>%
  summarise(mean=mean(value), median = median(value))

# outliers https://www.r-bloggers.com/2020/01/how-to-remove-outliers-in-r/

#https://www.r-bloggers.com/2017/06/add-p-values-and-significance-levels-to-ggplots
compare_means(value~GEO, beef_cons, method = "kruskal.test")

ggboxplot(beef_cons, x = "GEO", y = "value", color = "GEO", legend = "none")+
  stat_compare_means(method = "kruskal.test", label.y = 150)+ #adding kruskal p-value
  stat_compare_means(label = "p.signif", method = "t.test", ref.group = ".all.")+ #pairwise comparison against all
  geom_hline(yintercept = mean(beef_cons$value))+
  ylim(0,350)+
  theme(axis.title.y = element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "none",
        plot.caption = element_text(hjust = 0),)+
  labs(caption = "Beef consumption across provinces (g/cap)") 

ggsave("Results_Images/Dairy_consumption.pdf")

```

```{r VN_food, echo=FALSE, message = FALSE}

VNF_food_CAN <- bind_rows(VNF_meat_CAN, VNF_crop_group_CAN)

VN_food <- left_join(food_consum, VNF_food_CAN, by =c("food_group"="Food group"))%>%
  rename("GEO"="GEO.x")%>%
  mutate(`N kg/cap/year` = `consumed kg/cap` * `VNF kgN/kg`,
         `N kg/year` = `consumed kg` * `VNF kgN/kg`)%>%
  select(GEO, food_group, `N footprint sector`, `N kg/cap/year`, `N kg/year`)%>%
  rename(Subsector = food_group)%>%
  drop_na()

```

```{r wastewater, echo=FALSE, message = FALSE}
#Population served by municipal wastewater systems by treatment category (Canada/Province)
N_wastewater <-  read.csv("Data/Food/Wastewater/38100125.csv")%>%
  rename("year" = "..REF_DATE")%>%
  select(year, GEO, "Population.by.treatment.type", UOM, SCALAR_FACTOR, VALUE)%>%
  filter(`Population.by.treatment.type` != 'All treatment types')%>%
  group_by(year, GEO)%>% 
  #what percent of the population is served by each treatment type
  mutate(percent_pop=VALUE/sum(VALUE))%>%
  ungroup%>%
  mutate(`%N_removal` = case_when(`Population.by.treatment.type` == "No treatment" ~ 0,
                                  `Population.by.treatment.type` == "Primary treatment" ~ 0,
                                  `Population.by.treatment.type` == "Secondary treatment" ~ 0.25,
                                  `Population.by.treatment.type` == "Secondary treatment with additional phosphorus removal" ~ 0.25,
                                  `Population.by.treatment.type` == "Tertiary treatment" ~ 0.50))%>%
  filter(year %in% years)%>%
  group_by(GEO, VALUE, `Population.by.treatment.type`, `%N_removal`)%>%
  summarise(percent_pop = mean(percent_pop))%>%
  left_join(food_consum)%>%
  filter(!(GEO %in% c("Canada", "Yukon"))) #Canada average currently includes the North, need to remove and re-calculate for comparison with provinces

N_wastewater_prov <- N_wastewater%>%
  mutate(`N wastewater loss kg/cap/year` = `consumed N kg/cap` * (percent_pop) * (1-`%N_removal`),
         `N wastewater loss kg/year` = `consumed N kg` * (percent_pop) * (1-`%N_removal`))%>%
  group_by(GEO)%>%
  summarise(`N kg/cap/year` = sum(`N wastewater loss kg/cap/year`), `N kg/year` = sum(`N wastewater loss kg/year`))%>%
  mutate(`N footprint sector` = "Wastewater Treatment", "Subsector" = "Wastewater Treatment")%>%
  left_join(prov_pop)
 
N_wastewater_CAN <- N_wastewater_prov%>%
  summarize_if(is.numeric, funs(weighted.mean(.,Population)))%>%
  mutate(`N footprint sector` = "Wastewater Treatment", "Subsector" = "Wastewater Treatment", GEO = "Canada")

N_wastewater_Total <- bind_rows(N_wastewater_prov, N_wastewater_CAN)%>%
  select(!(Population))
  
```

```{r N footprint, echo=FALSE}
N_footprint <- bind_rows(N_wastewater_Total, N_energy)%>%
  bind_rows(VN_food)%>%
  mutate(GEO = fct_relevel(GEO, "Canada", "British Columbia", "Alberta", "Saskatchewan", "Manitoba", "Ontario", "Quebec", "New Brunswick", "Nova Scotia", "Prince Edward Island", "Newfoundland and Labrador"), 
         Subsector = fct_relevel(Subsector, "Beef", "Pork", "Chicken", "Eggs", "Dairy", "Legumes", "Oilseeds", "Grains", "Fruits", "Vegetables", "Roots", "Wastewater Treatment", "Electricity Generation", "Oil and Gas Industry", "Transport"),
         `N footprint sector` = fct_relevel(`N footprint sector`, "VN from meat","VN from crops", "Wastewater Treatment", "Fossil Fuels"))%>%
  filter(!(Subsector %in% c("Transport", "Beef", "Oil and Gas Industry")))

write_csv(N_footprint,"Results_Images/N_footprint.csv")

```

# Results and Images

```{r VNF food crop graph}
ggplot(VNF_crop_group, aes(fill = `GEO`, y = `VNF kgN/kg`*1000, x = `GEO`))+
  geom_bar(position="stack", stat="identity") +
  facet_wrap(~factor(`Food group`))+
  scale_y_sqrt(breaks = c(10,40,80,120))+
  coord_flip()+
  labs(caption = "Virtual nitrogen factors (g N / kg) for food crops") +
  scale_fill_brewer(palette="Paired")+
  theme_classic()+
  theme(axis.title.y = element_blank(), 
        axis.title.x = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.25),
        panel.grid = element_blank(),
        panel.border = element_blank(),
        plot.caption = element_text(hjust = 0))

#ggsave("Results_Images/VNF_crop_CAN.pdf")

```

```{r Meat VNF graph, echo=FALSE, message = FALSE}

ggplot(VNF_meat, aes(fill = `GEO`, y = `VNF kgN/kg`*1000, x = `GEO`))+
  geom_bar(position="stack", stat="identity") +
  facet_wrap(~factor(`Food group`, levels=c("Beef", "Pork", "Milk", "Chicken", "Eggs")), scales = "free_x")+
  labs(caption = "Virtual nitrogen factors (g N / kg) for animal products") +
  scale_fill_brewer(palette="Paired")+
  coord_flip()+
  theme_classic()+
  theme(axis.title.y = element_blank(), 
        axis.title.x = element_blank(),
        legend.position = "none",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.25),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_blank(),
        plot.caption = element_text(hjust = 0))

#check way to change jut beef scale grob, facet grid
#fix scale

#ggsave("Results_Images/VNF_meat_avg.pdf")

```

```{r Total N footprint graph, echo=FALSE, message = FALSE}

colors <- 15
mycolors <- colorRampPalette(brewer.pal(12, "Paired"))(colors)

ggplot(subset(N_footprint, GEO %in% c("Newfoundland and Labrador", "Prince Edward Island", "Nova Scotia", "New Brunswick", "Quebec", "Ontario", "Manitoba", "Saskatchewan", "Alberta", "British Columbia")), aes(fill = `N footprint sector`, y = `N kg/year`/1000000, x = GEO))+
  geom_bar(stat="identity") +
  scale_fill_manual(values = mycolors)+
  scale_x_discrete(labels = wrap_format(10))+
  scale_y_sqrt()+
  labs(y = "N Gg/year")+
  coord_flip()+
  theme_classic()+
  theme(
    axis.text.x = element_text(size=8, angle = 90, hjust = 1, vjust = 0.5),
    axis.title.y = element_blank(),
    axis.ticks = element_blank(),
    plot.caption = element_text(hjust = 0))
#ggsave("Results_Images/N_print_subsectors_total.pdf")  

```

```{r Provincial footprints per capita, echo=FALSE, message = FALSE}
colors <- 15
mycolors <- colorRampPalette(brewer.pal(12, "Paired"))(colors)

ggplot(N_footprint, aes(fill = `Subsector`, y = `N kg/cap/year`, x = GEO))+
  geom_bar(stat="identity") +
  scale_fill_brewer(palette="Paired")+
  labs(caption = "Provincial Nitrogen footprints (N kg/cap/year)")+
  scale_x_discrete(labels = wrap_format(10))+
  coord_flip()+
  theme_classic()+
  theme(
    axis.text.x = element_text(size=8, angle = 90, hjust = 1, vjust = 0.5),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks = element_blank(),
    plot.caption = element_text(hjust = 0))
#ggsave("Results_Images/N_print_sectors_cap.pdf")

```

```{r Nitrogen footprint subsectors graph, echo=FALSE}
N_footprint <- read_csv("Results_Images/N_footprint.csv")

colors <- 15
mycolors <- colorRampPalette(brewer.pal(12, "Paired"))(colors)

ggplot(N_footprint, aes(fill = `Subsector`, y = `N kg/cap/year`, x = GEO))+
  geom_bar(position = "fill", stat="identity") +
  scale_fill_manual(values = mycolors)+
  labs(caption = "Provincial Nitrogen footprints (N kg/cap/year)")+
  coord_flip()+
  scale_x_discrete(labels = wrap_format(10))+
  guides(fill=guide_legend(ncol=1))+
  theme_classic()+
  theme(
    axis.text.x = element_text(size=8, angle = 90, hjust = 1, vjust = 0.5),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks = element_blank(),
    plot.caption = element_text(hjust = 0))
#ggsave("Results_Images/N_print_subsectors_cap.pdf")  

```



```{r, echo=FALSE, message = FALSE}


```


